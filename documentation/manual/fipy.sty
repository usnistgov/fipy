\NeedsTeXFormat{LaTeX2e} %[1995/12/01]
\ProvidesPackage{fipy}
	     [2008/10/09 Document style (FiPy manual)]

% Pass options to the epydoc base package.
\RequirePackage{xkeyval}
\DeclareOptionX{index}{\PassOptionsToPackage{index}{examples/latex/epydoc-base}}
\DeclareOptionX{hyperlink}{\PassOptionsToPackage{hyperlink}{examples/latex/epydoc-base}}
\DeclareOptionX{title}[]{\PassOptionsToPackage{title={#1}}{examples/latex/epydoc-base}}
\DeclareOptionX{creator}[]{\PassOptionsToPackage{creator={#1}}{examples/latex/epydoc-base}}

% Put Part as topmost level in PDF bookmarks
\def\tocPDFlevel{-1}
\DeclareOptionX{tocAsPDFpart}{\def\tocPDFlevel{-1}}
\DeclareOptionX{tocAsPDFchapter}{\def\tocPDFlevel{0}}

\ProcessOptionsX\relax

% \usepackage{xr-hyper}

% \RequirePackage[hyperlink]{examples/latex/epydoc-base}
\RequirePackage{examples/latex/epydoc-base}
\RequirePackage{longtable}

\RequirePackage{crop}

% \tocotherhead{part}
% \renewcommand{\bibsection}{% 
% \part{\bibname} 
% \prebibhook}

\renewcommand{\bibsection}{% 
\chapter*{\bibname} 
\bibmark 
\ifnobibintoc\else 
\phantomsection 
\addcontentsline{toc}{part}{\bibname} 
\fi 
\prebibhook}

\setlength{\columnsep}{35pt}

\RequirePackage{amsmath} 

\DeclareMathOperator{\erf}{erf}
\newcommand{\abs}[1]{\lvert#1\rvert}

\RequirePackage{color}
\definecolor{UrlColor}{rgb}{0,0.08,0.45}
% \RequirePackage[pdftex, hyperfigures=true, pagebackref, pdftitle={FiPy User's Guide}, pdfcreator={epydoc 3.0beta1}, bookmarks=true, bookmarksopen, bookmarksopenlevel=2, pdfpagemode=UseOutlines, colorlinks=true, plainpages=false, pdfpagelabels, linkcolor=blue, anchorcolor=black, citecolor=black, filecolor=black, menucolor=black, pagecolor=black, urlcolor=UrlColor]{hyperref}

\RequirePackage[tight]{minitoc}
\setcounter{parttocdepth}{2}
\mtcsetrules{parttoc}{off}

\definecolor{darkblue}{rgb}{0,0.05,0.35}
\definecolor{redish}{rgb}{0.894,0.122,0.122}
\definecolor{bluish}{rgb}{0.216,0.188,0.533}
% \RequirePackage[pdftex]{graphicx}

\graphicspath{{./api/latex/},{../figures/},{images/}}

\renewcommand{\sectionmark}[1]{\markboth{#1}{}}
\renewcommand{\subsectionmark}[1]{\markright{#1}}

\newenvironment{changemargin}[2]{%
 \begin{list}{}{%
  \setlength{\topsep}{0pt}%
  \setlength{\leftmargin}{#1}%
  \setlength{\rightmargin}{#2}%
  \setlength{\listparindent}{\parindent}%
  \setlength{\itemindent}{\parindent}%
  \setlength{\parsep}{\parskip}%
 }%
\item[]}{\end{list}}

\renewcommand\tableofcontents{%
    \if@twocolumn
      \@restonecoltrue\onecolumn
    \else
      \@restonecolfalse
    \fi
    \chapter*{\contentsname\pdfbookmark[\tocPDFlevel]{Contents}{contents}
	\@mkboth{%
	   \MakeUppercase\contentsname}{\MakeUppercase\contentsname}}%
    \@starttoc{toc}%
    \if@restonecol\twocolumn\fi
    }

\newcounter{FAQdepth}
\setcounter{FAQdepth}{0}

\newenvironment{FAQ}%
               {\list{}{\stepcounter{FAQdepth}%
                        \labelwidth\z@ \itemindent-\leftmargin
                        \let\makelabel\FAQlabel}}%
               {\addtocounter{FAQdepth}{-1}%
               \endlist}
\newcommand*{\FAQlabel}[1]{\hspace\labelsep
                                   \normalfont\bfseries #1%
                           \ifnum\value{FAQdepth}=1\relax
                               \addcontentsline{toc}{section}{#1}
                           \else\ifnum\value{FAQdepth}=2\relax
                               \addcontentsline{toc}{subsection}{#1}   
                           \fi
                           \fi\adjustmtc}
                           
                           
\newcommand{\@Code}[1]{\texttt{#1}}
\newcommand{\IndexClass}[1]{\index{#1@\protect\EpydocIndex{#1}{\EpydocDottedName{#1}}{class} class}}
% \newcommand{\IndexClass}[1]{\index{#1 class}}
\newcommand{\IndexModule}[1]{\index{#1@\protect\EpydocIndex{#1}{\EpydocDottedName{#1}}{module} module}}
\newcommand{\IndexPackage}[1]{\index{#1@\protect\EpydocIndex{#1}{\EpydocDottedName{#1}}{package} package}}
\newcommand{\IndexSoftware}[1]{\index{#1@\@Software{#1}}}
\newcommand{\IndexFunction}[1]{\index{#1@\protect\EpydocIndex{#1}{\EpydocDottedName{#1}}{function}}}
\newcommand{\IndexConstant}[2]{\index{$#1\equiv\text{#2}$@$#1\equiv\text{\protect\EpydocIndex{#2}{\EpydocDottedName{#2}}{module}}$}%
                               \index{#2$\equiv #1$@$\text{\protect\EpydocIndex{#2}{\EpydocDottedName{#2}}{module}}\equiv #1$}}
\newcommand{\Class}[1]{\@Code{#1}\IndexClass{#1}}
\newcommand{\Module}[1]{\@Code{#1}\IndexModule{#1}}

% commands for various weblinks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\@Software}[1]{\textsf{#1}}
\newcommand{\@Org}[1]{\textsf{#1}}

\newcommand{\FiPy}{\@Software{FiPy}}

\newcommand{\@OrgURL}[2]{\href{#2}{\@Org{#1}}\index{#1@\@Org{#1}}}

\newcommand{\@SoftwareURL}[2]{\href{#2}{\@Software{#1}}\IndexSoftware{#1}}

\newcommand{\SciPy}{\@SoftwareURL{SciPy}{http://www.scipy.org/}}

\newcommand{\PyRex}{\@SoftwareURL{PyRex}{http://www.cosc.canterbury.ac.nz/~greg/python/Pyrex/}}

\newcommand{\Python}{\@SoftwareURL{Python}{http://www.python.org/}}

\newcommand{\Numeric}{\@SoftwareURL{Numeric}{http://www.numpy.org/}}

\newcommand{\PyX}{\@SoftwareURL{PyX}{http://pyx.sourceforge.net/}}

\newcommand{\Pygist}{\@SoftwareURL{Pygist}{http://bonsai.ims.u-tokyo.ac.jp/~mdehoon/software/python/pygist.html}%
                     \IndexSoftware{gist}}

\newcommand{\Matplotlib}{\@SoftwareURL{Matplotlib}{http://matplotlib.sourceforge.net}}

\newcommand{\MayaVi}{\@SoftwareURL{MayaVi}{http://mayavi.sourceforge.net}}

\newcommand{\PySparse}{\@SoftwareURL{PySparse}{http://people.web.psi.ch/geus/pyfemax/pysparse.html}}

\newcommand{\ScientificPython}{\@SoftwareURL{Scientific Python}{http://starship.python.net/~hinsen/ScientificPython/}}

\newcommand{\MacOSX}{\@SoftwareURL{Mac OS X}{http://www.apple.com/macosx/}}

\newcommand{\Gmsh}{\@SoftwareURL{Gmsh}{http://www.geuz.org/gmsh/}}

\newcommand{\weave}{\@SoftwareURL{weave}{http://www.scipy.org/documentation/weave/}}

\newcommand{\blitz}{\@SoftwareURL{blitz}{http://www.scipy.org/documentation/weave/}}

\newcommand{\doctest}{\@SoftwareURL{doctest}{http://www.python.org/doc/current/lib/module-doctest.html}}

\newcommand{\unittest}{\@SoftwareURL{unittest}{http://www.python.org/doc/current/lib/module-unittest.html}}

\newcommand{\NIST}{\@OrgURL{NIST}{http://www.nist.gov/}}

\newcommand{\CTCMS}{\@OrgURL{http://www.ctcms.nist.gov/}{\textsf{CTCMS}}}

\newcommand{\MSEL}{\@OrgURL{http://www.msel.nist.gov/}{\textsf{MSEL}}}


% \mod#dofipy.variables.variable.\relax.
% 
% \expandafter\mod@join{fipy (module)}\expandafter\mod@dovariables.variable.\relax.

% differentiate the appearance of different Index items (somewhat 
% overriden by url.sty-formatted items).
\renewcommand{\EpydocIndex}[3]{%
%     #2%
    \ifthenelse{\equal{#3}{}}{}{%
        \ifthenelse{\equal{#3}{method}\OR\equal{#3}{function}}{%
            #2()%
        }{%
            \ifthenelse{\equal{#3}{module}\OR\equal{#3}{package}}{%
                #2}{%
                \ifthenelse{\equal{#3}{class}}{%
                    #2}{%\textbf{#2}
                    #2 \textit{(\MakeLowercase{#3})}}}%
        }%
    }%
}

\definecolor{hazy-gray}{gray}{0.96}
\definecolor{light-gray}{gray}{0.8}
\definecolor{middle-gray}{gray}{0.55}
\definecolor{hazy-yellow}{rgb}{1.0,1.0,0.8}
\definecolor{hazy-orange}{rgb}{1.0,0.75,0.4}
\definecolor{hazy-red}{rgb}{1.0,0.8,0.8}

\usepackage{calc}

% lifted from <http://www.texnik.de/color/color.phtml> for colored 
% paragraph boxes
\newcommand{\cmcolor}{}
\newenvironment{cminipage}[1][white]%
  {%\setlength{\fboxsep}{-\fboxrule}
   \renewcommand{\cmcolor}{#1}\noindent%
   \begin{lrbox}{\@tempboxa}%
     \begin{minipage}{\linewidth-2\fboxsep}}%
  {  \end{minipage}%
   \end{lrbox}%
   \colorbox{\cmcolor}{\usebox{\@tempboxa}}}%

\renewenvironment{EpydocFunctionSignature}[1]{%
    \gdef\and{, }%
    \newcommand{\VarArg}[1]{*\textit{##1}}%
    \newcommand{\GenericArg}{\textit{\ldots}}%
    \newcommand{\KWArg}[1]{**\textit{##1}}%
    \newcommand{\ArgList}[1]{(##1)}%
    \newcommand{\Param}[2][]{%
        \textit{##2}%
        \ifthenelse{\equal{##1}{}}{}{=\texttt{##1}}}%
    \raggedright\Large\@hangfrom{\ttfamily #1(}}%
    {{\ttfamily)\par}\vspace*{-2\EpydocParskip}\rule{\textwidth}{0.5\fboxrule}}%
    
% % indent on left
% \renewenvironment{EpydocDocstring}{%
%     \begin{list}{}{\leftmargin1.5em}\item{}}
%     {\end{list}}

% box in gray, indent on left
\renewenvironment{EpydocFunctionParameters}[1]{%
    \vspace{0.4ex}
    \begin{list}{}{\leftmargin1.5em}\item{}%
    \begin{cminipage}[light-gray]\textbf{Parameters}\begin{quote}%
    \renewcommand*{\descriptionlabel}[1]{\hspace\labelsep
       \normalfont\rmfamily\itshape ##1:}
    \begin{description}}
    {\end{description}\end{quote}\end{cminipage}\end{list}}

% \renewcommand{\EpydocFunctionReturns}[2][]{%
%     \vspace{0.4ex}
%     \begin{list}{}{\leftmargin1.5em}\item{}%
%     \begin{cminipage}[light-gray]\textbf{Return Value}
%     \begin{quote}
%         \gdef\@EpydocReturnType{#1}
%         \gdef\@EpydocReturnDescription{#2}
%         \ifx\@EpydocReturnType\empty
%             \@EpydocReturnDescription
%         \else
%             \ifx\@EpydocReturnDescription\empty
%                 \textit{\@EpydocReturnType}
%             \else
%                 \@EpydocReturnDescription \textit{(type=\@EpydocReturnType)}
%             \fi
%         \fi
%     \end{quote}\end{cminipage}\end{list}}

\renewenvironment{EpydocFunctionRaises}{%
    \vspace{0.4ex}
    \begin{list}{}{\leftmargin1.5em}\item{}%
    \begin{cminipage}[light-gray]\textbf{Raises}\begin{quote}%
    \renewcommand*{\descriptionlabel}[1]{\hspace\labelsep
       \normalfont\rmfamily\itshape ##1:}
    \begin{description}}
    {\end{description}\end{quote}\end{cminipage}\end{list}}

% indent on left
\renewcommand{\EpydocFunctionOverrides}[2][0]{%
    \begin{list}{}{\leftmargin1.5em}\item{}%
    \raggedright Overrides: #2() %
    \ifthenelse{#1=1}{\textit{(inherited documentation)}}{}%
    \end{list}}

% \renewenvironment{EpydocInheritanceList}{%
%     \renewcommand*{\descriptionlabel}[1]{\hspace\labelsep
%        \normalfont\bfseries Inherited from ##1:}
%     \raggedright\begin{description}}
%     {\end{description}}
% 
% \renewenvironment{EpydocDescriptionShortList}[1]{%
%     \gdef\and{, }%
%     \raggedright\begin{description}\item[#1: ]}
%     {\end{description}}

\renewenvironment{EpydocModuleList}{%
    \newcommand{\CrossRef}[1]{}
    \begin{itemize}
        \renewcommand{\makelabel}[1]{\textbf{##1}}
        \setlength{\parskip}{0ex}}
    {\end{itemize}}

% \renewenvironment{EpydocModuleSubList}{%
%     \begin{itemize}
%         \renewcommand{\makelabel}[1]{\textbf{##1}}
%         \setlength{\parskip}{0ex}}
%     {\end{itemize}}

\renewenvironment{EpydocMetadataShortList}[1]{%
    \renewcommand{\and}{, }%
    \par
    \begin{list}{}{\itemindent-\leftmargin}
    \item \textbf{#1:} \ignorespaces}
    {\end{list}\ignorespacesafterend\par}

% Same as book.cls, except ragged-right. Looks much better for long 
% module names.
\renewcommand\section{\@startsection {section}{1}{\z@}%
                                   {-3.5ex \@plus -1ex \@minus -.2ex}%
                                   {2.3ex \@plus.2ex}%
                                   {\raggedright\normalfont\Large\bfseries}}
\renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
                                     {-3.25ex\@plus -1ex \@minus -.2ex}%
                                     {1.5ex \@plus .2ex}%
                                     {\raggedright\normalfont\large\bfseries}}
\renewcommand\subsubsection{\@startsection{subsubsection}{3}{\z@}%
                                     {-3.25ex\@plus -1ex \@minus -.2ex}%
                                     {1.5ex \@plus .2ex}%
                                     {\raggedright\normalfont\normalsize\bfseries}}
\renewcommand\paragraph{\@startsection{paragraph}{4}{\z@}%
                                    {3.25ex \@plus1ex \@minus.2ex}%
                                    {-1em}%
                                    {\raggedright\normalfont\normalsize\bfseries}}
\renewcommand\subparagraph{\@startsection{subparagraph}{5}{\parindent}%
                                       {3.25ex \@plus1ex \@minus .2ex}%
                                       {-1em}%
                                      {\raggedright\normalfont\normalsize\bfseries}}

\def\url@pystyle{%
\@ifundefined{selectfont}{\def\UrlFont{\tt}}{\def\UrlFont{\ttfamily}}\Url@pydo
}

\usepackage{booktabs}

\renewenvironment{reSTadmonition}[1][]{%
    \begin{center}\begin{sffamily}%
    \ifthenelse{\equal{#1}{}\OR\equal{#1}{Note}}{
        \begin{cminipage}[light-gray]
    }{%
        \ifthenelse{\equal{#1}{Warning}}{%
            \begin{cminipage}[hazy-red] %[hazy-yellow]
        }{%
            \ifthenelse{\equal{#1}{Attention!}}{%
                \begin{cminipage}[hazy-orange]
            }{%
                \ifthenelse{\equal{#1}{Danger}}{%
                    \begin{cminipage}[hazy-red]
                }{%
                    \begin{cminipage}
                }%
            }%
        }%
    }%
    \ifthenelse{\equal{#1}{}}{}{\textbf{\large #1}\vspace{1ex}}%
    \raggedright}
    {\end{cminipage}\end{sffamily}\end{center}}


% don't restart page counter between frontmatter and mainmatter
\renewcommand{\pagenumbering}[1]{%
  \gdef\thepage{\csname @#1\endcsname\c@page}}
  
% blank pages should be BLANK
\let\origdoublepage\cleardoublepage
\newcommand{\clearemptydoublepage}{%
  \clearpage
  {\pagestyle{empty}\origdoublepage}%
}
\let\cleardoublepage\clearemptydoublepage
\let\afterparttoc\clearemptydoublepage

\newenvironment{FiPyDocumentationExample}{
    \renewcommand{\index}[1]{}
    \renewcommand{\@startsection}[6]{%
      \ifraggedbottomsection\if@nobreak\else
        \vskip\z@\@plus\bottomsectionskip
        \penalty\z@
        \vskip\z@\@plus -\bottomsectionskip
      \fi\fi
      \if@noskipsec \leavevmode \fi
      \par
      \@tempskipa ##4\relax
      \@afterindenttrue
      \ifdim \@tempskipa <\z@
        \@tempskipa -\@tempskipa \@afterindentfalse
      \fi
      \if@nobreak
        \everypar{}%
      \else
        \addpenalty\@secpenalty\addvspace\@tempskipa
      \fi
      \@ssect{##3}{##4}{##5}{##6}}
    \begin{framed}
    }{%
    \end{framed}}


\@ifclassloaded{memoir}{%

\newcommand{\logo}{\rotatebox{4}{\textcolor{redish}{\( \varphi \)}}\kern-.70em\raisebox{-.15em}{\textcolor{bluish}{\( \pi\)}}}

\newsavebox{\NISTbox}
\sbox{\NISTbox}{\includegraphics[trim=5 2 5 5,scale=1.5]{NIST_right2line}}

\input{version}

\copypagestyle{fipy}{Ruled}
\makeevenhead{fipy}{\thepage}{}{\slshape\leftmark}
\makeoddhead{fipy}{\slshape\rightmark}{}{\thepage}
\makeevenfoot{fipy}{}{}{}
\makeoddfoot{fipy}{}{}{}

\pagestyle{fipy}

\newcommand*{\ps@mytitlepage}{%
  \let\@oddhead\@empty
  \renewcommand*{\@oddfoot}{%
  \rule{6.4in}{0in}\raisebox{-0.6in}{\parbox[b][0pt]{0pt}{\makebox[0pt][r]{\usebox{\NISTbox}}}}}}

\copypagestyle{titlingpage}{empty} 
\makeoddfoot{titlingpage}{}{}{\rule{7in}{0in}\raisebox{-0.6in}{\parbox[b][0pt]{0pt}{\makebox[0pt][r]{\usebox{\NISTbox}}}}}

\def\@makeaffiliation{\begingroup
\gdef\and{\\}
\textit{
\begin{tabular}[t]{r@{}}%
    \@affiliation
\end{tabular}}
\endgroup
}

\def\subtitle#1{\gdef\@subtitle{#1}}
\def\@subtitle{}
\def\affiliation#1{\begingroup
\gdef\and{\\}
\gdef\@affiliation{#1}
\endgroup
}
\def\@affiliation{}

\setlength{\droptitle}{-1.4in}

\renewcommand{\maketitlehooka}{%
    \begin{changemargin}{-1in}{-0.5in}%
    \let\footnotesize\small%
    \let\footnoterule\relax%
    \let \footnote \thanks%
    \begin{flushright}%
%       \vspace*{-0.6in}
      \scalebox{10}{\logo}\par
      \vskip 3em%
    \end{flushright}
}

\pretitle{\begin{flushright}\Huge}
\posttitle{\par\end{flushright}}

\renewcommand{\maketitlehookb}{%
\begin{flushright}
\huge \@subtitle \par
\end{flushright}
\vskip 3em%
}

\preauthor{\begin{flushright}%
\renewcommand*{\andnext}{\\}%
\large\lineskip 0.75em% 
\begin{tabular}[t]{r@{}}} 
\postauthor{\end{tabular}\par\end{flushright}} 

\renewcommand{\maketitlehookc}{%
\begin{flushright}
\par \@makeaffiliation \par%
\end{flushright}
\vskip 1.5em%
}
 
\predate{\begin{flushright}\large}
\postdate{\par\end{flushright}}

\renewcommand{\maketitlehookd}{%
\vskip 1.5em%
\begin{flushright}
{\large Version~\Version \par}
\vspace*{\fill}
\end{flushright}
\end{changemargin}
}

\renewcommand{\@m@mchapter}[1][]{%
  \def\ch@pt@c{#1}% capture first optional arg
   \@ifnextchar[{\@chapter}{\@chapter[]}%
}
\def\@chapter[#1]#2{%
% if |\ch@pt@c| is empty, no [ was found at all. Use |#2| as
% entry for all fields.
   \ifx\ch@pt@c\@empty
     \def\f@rtoc{#2}%
     \def\f@rhdr{#2}%
   \else
% otherwise at least one [ was found. If |#1| is empty then only
% one was found.
     \let\f@rtoc\ch@pt@c
     \ifx\@empty#1\@empty
       \let\f@rhdr\ch@pt@c
     \else
       \def\f@rhdr{#1}%
     \fi
   \fi
   \ifnum \c@secnumdepth >\m@ne
     \if@mainmatter
       \refstepcounter{chapter}%
     \fi
   \fi
   \chaptermark{\f@rhdr}%
   \ifartopt
     \@makechapterhead{#2}%
     \@afterheading
   \else
     \insertchapterspace
     \if@twocolumn
       \@topnewpage[\@makechapterhead{#2}]%
     \else
       \@makechapterhead{#2}%
     \fi
     \@afterheading
   \fi
   \ifnum \c@secnumdepth >\m@ne
     \if@mainmatter
       \ifanappendix
         \addcontentsline{toc}{appendix}{%
           \protect\chapternumberline{\thechapter}\f@rtoc}%
       \else
         \addcontentsline{toc}{chapter}{%
           \protect\chapternumberline{\thechapter}\f@rtoc}%
       \fi
     \else
       \addcontentsline{toc}{chapter}{\f@rtoc}%
     \fi
   \else
     \addcontentsline{toc}{chapter}{\f@rtoc}%
   \fi
   \ifheadnameref\M@gettitle{\f@rhdr}\else\M@gettitle{\f@rtoc}\fi
}

% % Temporary(?) patch supplied by Morten H¿gholm in
% % <http://groups.google.com/group/comp.text.tex/browse_frm/thread/911a3cd94427194a/e22e4003b9ac2ff1?hl=en#e22e4003b9ac2ff1

\usepackage{memhfixc}

}{
% lifted from memoir.cls
\newcommand{\hangfrom}[1]{%
  \setbox\@tempboxa\hbox{{#1}}%
  \hangindent \wd\@tempboxa\noindent\box\@tempboxa}
}
    

