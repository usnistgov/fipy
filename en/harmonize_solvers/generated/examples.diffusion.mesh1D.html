
<!DOCTYPE html>


<!--[if IEMobile 7]><html class="iem7 no-js"  lang="en" dir="ltr"><![endif]-->
<!--[if lte IE 6]><html class="lt-ie9 lt-ie8 lt-ie7 no-js"  lang="en" dir="ltr"><![endif]-->
<!--[if (IE 7)&(!IEMobile)]><html class="lt-ie9 lt-ie8 no-js"  lang="en" dir="ltr"><![endif]-->
<!--[if IE 8]><html class="lt-ie9 no-js"  lang="en" dir="ltr"><![endif]-->
<!--[if (gte IE 9)|(gt IEMobile 7)]><!--><html class="no-js"  lang="en" dir="ltr" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# book: http://ogp.me/ns/book# profile: http://ogp.me/ns/profile# video: http://ogp.me/ns/video# product: http://ogp.me/ns/product# content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#"><!--<![endif]-->

  <head>
<meta charset="utf-8" />
<link rel="shortcut icon" href="https://www.nist.gov/sites/all/themes/nist_style/favicon.ico" type="image/vnd.microsoft.icon" />
<script type="text/x-mathjax-config">MathJax.Hub.Config({
  extensions: ['tex2jax.js'],
  jax: ['input/TeX','output/HTML-CSS'],
  tex2jax: {
    inlineMath: [ ['$$','$$'], ['\\(','\\)'] ],
    processEscapes: true,
    processClass: 'tex2jax',
    ignoreClass: 'html'
  },
  showProcessingMessages: false,
  messageStyle: 'none'
});
</script>
<meta name="MobileOptimized" content="width">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">

      <!--[if lt IE 9]>
    <script src="https://www.nist.gov/sites/all/themes/zen/js/html5-respond.js"></script>
    <![endif]-->
    <!--[if (gte IE 6)&(lte IE 8)]>
  <script type="text/javascript" src="https://www.nist.gov/sites/all/themes/nist_style/js/selectivizr-min.js"></script>
  <![endif]--><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>examples.diffusion.mesh1D &#8212; FiPy 3.4.5+370.g2caf71221 documentation</title>
    <link rel="stylesheet" href="../_static/ntd2d.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/ntd2d.css?v=de7af573" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/widetable.css?v=32b6a719" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=e6aba33a"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="canonical" href="https://pages.nist.gov/fipy/en/latest/generated/examples.diffusion.mesh1D.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="FiPy 3.4.5+370.g2caf71221 documentation" href="../contents.html" />
    <link rel="up" title="examples.diffusion" href="examples.diffusion.html" />
    <link rel="next" title="examples.diffusion.mesh20x20" href="examples.diffusion.mesh20x20.html" />
    <link rel="prev" title="examples.diffusion.explicit.tri2D" href="examples.diffusion.explicit.tri2D.html" />
  
 


  <link rel="stylesheet" href="https://pages.nist.gov/nist-header-footer/css/nist-combined.css">
  <script src="https://code.jquery.com/jquery-3.6.2.min.js" type="text/javascript" defer="defer"></script>
  <script src="https://pages.nist.gov/nist-header-footer/js/nist-header-footer.js" type="text/javascript" defer="defer"></script>


  </head>
<!--  <body role="document">-->
  <body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-414011 node-type-software hide-breadcrumb section-services-resources page-panels is-panel" role="document">
      <div id="page" class="mini-header">



    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="examples.diffusion.mesh20x20.html" title="examples.diffusion.mesh20x20"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="examples.diffusion.explicit.tri2D.html" title="examples.diffusion.explicit.tri2D"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html"><img src="../_static/fipy.png" alt="FiPy logo"
                 style="vertical-align: middle; margin-top: -1px"/>
        FiPy</a> &gt;</li>

          <li class="nav-item nav-item-1"><a href="../API.html" ><code class="xref py py-mod docutils literal notranslate"><span class="pre">fipy</span></code> Package Documentation</a> &gt;</li>
          <li class="nav-item nav-item-2"><a href="examples.html" >examples</a> &gt;</li>
          <li class="nav-item nav-item-3"><a href="examples.diffusion.html" accesskey="U">examples.diffusion</a> &gt;</li> 
      </ul>
    </div>

  <div id="main" class="clearfix" role="main" tabindex="-1">
    <div class="main__inner">
      <div class="page-info">
        <a id="main-content"></a>
      </div>

      <div class="document">
        <div class="documentwrapper">

      <div id="content" class="column">
      <div id="block-nist-www-content" class="nist-block">
        <section class="nist-page__content usa-section clearfix">

         

        <div class="grid-container margin-top-4">
        <div class="grid-row grid-gap-6">

  <div class="nist-page__region nist-page__region--content tablet-lg:grid-col-8">
              <div class="body" role="main">
		
  <section id="module-examples.diffusion.mesh1D">
<span id="examples-diffusion-mesh1d"></span><h1>examples.diffusion.mesh1D<a class="headerlink" href="#module-examples.diffusion.mesh1D" title="Permalink to this heading">¶</a></h1>
<p>Solve a one-dimensional diffusion equation under different conditions.</p>
<p>To run this example from the base <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a> directory, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python examples/diffusion/mesh1D.py
</pre></div>
</div>
<p>at the command line. Different stages of the example should be displayed,
along with prompting messages in the terminal.</p>
<p>This example takes the user through assembling a simple problem with <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a>.
It describes different approaches to a 1D diffusion problem with constant
diffusivity and fixed value boundary conditions such that,</p>
<div class="math notranslate nohighlight" id="equation-eq-diffusion-mesh1d-constantd">
<span class="eqno">(1)<a class="headerlink" href="#equation-eq-diffusion-mesh1d-constantd" title="Permalink to this equation">¶</a></span>\[\frac{\partial \phi}{\partial t} = D \nabla^2 \phi.\]</div>
<p>The first step is to define a one dimensional domain with 50 solution
points. The <code class="xref py py-class docutils literal notranslate"><span class="pre">Grid1D</span></code> object represents a linear structured grid. The
parameter <code class="docutils literal notranslate"><span class="pre">dx</span></code> refers to the grid spacing (set to unity here).</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">FaceVariable</span><span class="p">,</span> <span class="n">CellVariable</span><span class="p">,</span> <span class="n">Grid1D</span><span class="p">,</span> <span class="n">ExplicitDiffusionTerm</span><span class="p">,</span> <span class="n">TransientTerm</span><span class="p">,</span> <span class="n">DiffusionTerm</span><span class="p">,</span> <span class="n">Viewer</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy.tools</span> <span class="kn">import</span> <span class="n">numerix</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nx</span> <span class="o">=</span> <span class="mi">50</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dx</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mesh</span> <span class="o">=</span> <span class="n">Grid1D</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a> solves all equations at the centers of the cells of the mesh. We
thus need a <a class="reference internal" href="fipy.variables.cellVariable.html#fipy.variables.cellVariable.CellVariable" title="fipy.variables.cellVariable.CellVariable"><code class="xref py py-class docutils literal notranslate"><span class="pre">CellVariable</span></code></a> object to hold the values of the
solution, with the initial condition <span class="math notranslate nohighlight">\(\phi = 0\)</span> at <span class="math notranslate nohighlight">\(t = 0\)</span>,</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;solution variable&quot;</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
<p>We’ll let</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">D</span> <span class="o">=</span> <span class="mf">1.</span>
</pre></div>
</div>
<p>for now.</p>
<p>The boundary conditions</p>
<div class="math notranslate nohighlight">
\[\begin{split}\phi =
\begin{cases}
    0&amp; \text{at \(x = 1\),} \\
    1&amp; \text{at \(x = 0\).}
\end{cases}\end{split}\]</div>
<p>are formed with a value</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">valueLeft</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">valueRight</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>and a set of faces over which they apply.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only faces around the exterior of the mesh can be used for boundary
conditions.</p>
</div>
<p>For example, here the exterior faces on the left of the domain are extracted by
<code class="docutils literal notranslate"><span class="pre">mesh</span></code>.<a class="reference internal" href="fipy.meshes.abstractMesh.html#fipy.meshes.abstractMesh.AbstractMesh.facesLeft" title="fipy.meshes.abstractMesh.AbstractMesh.facesLeft"><code class="xref py py-attr docutils literal notranslate"><span class="pre">facesLeft</span></code></a>. The boundary
conditions are applied using
<code class="docutils literal notranslate"><span class="pre">phi</span></code>. <a class="reference internal" href="fipy.variables.variable.html#fipy.variables.variable.Variable.constrain" title="fipy.variables.variable.Variable.constrain"><code class="xref py py-meth docutils literal notranslate"><span class="pre">constrain()</span></code></a> with these faces and
a value (<code class="docutils literal notranslate"><span class="pre">valueLeft</span></code>).</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">valueRight</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesRight</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">valueLeft</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesLeft</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If no boundary conditions are specified on exterior faces, the default
boundary condition is no-flux,
<span class="math notranslate nohighlight">\(\vec{n} \cdot (D \nabla \phi) \rvert_\text{someFaces} = 0\)</span>.</p>
</div>
<p>If you have ever tried to numerically solve
Eq. <a class="reference internal" href="#equation-eq-diffusion-mesh1d-constantd">(1)</a>,
you most likely attempted “explicit finite differencing” with code
something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span>
        <span class="n">phi_new</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi_old</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> \
          <span class="o">+</span> <span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi_old</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi_old</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_old</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">time</span> <span class="o">+=</span> <span class="n">dt</span>
</pre></div>
</div>
<p>plus additional code for the boundary conditions. In <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a>, you would write</p>
<div class="doctest highlight-default notranslate" id="index-0"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">eqX</span> <span class="o">=</span> <span class="n">TransientTerm</span><span class="p">()</span> <span class="o">==</span> <span class="n">ExplicitDiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
<p>The largest stable timestep that can be taken for this explicit 1D
diffusion problem is <span class="math notranslate nohighlight">\(\Delta t \le \Delta x^2 / (2 D)\)</span>.</p>
<p>We limit our steps to 90% of that value for good measure</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">timeStepDuration</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">steps</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
<p>If we’re running interactively, we’ll want to view the result, but not if
this example is being run automatically as a test. We accomplish this by
having Python check if this script is the “<code class="docutils literal notranslate"><span class="pre">__main__</span></code>” script, which will
only be true if we explicitly launched it and not if it has been imported
by another script such as the automatic tester. The factory function
<a class="reference internal" href="fipy.viewers.html#fipy.viewers.Viewer" title="fipy.viewers.Viewer"><code class="xref py py-func docutils literal notranslate"><span class="pre">Viewer()</span></code></a> returns a suitable viewer depending on available
viewers and the dimension of the mesh.</p>
<div class="doctest highlight-default notranslate" id="index-1"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phiAnalytical</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;analytical value&quot;</span><span class="p">,</span>
<span class="gp">... </span>                             <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span> <span class="o">=</span> <span class="n">Viewer</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">phiAnalytical</span><span class="p">),</span>
<span class="gp">... </span>                    <span class="n">datamin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">datamax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<p>In a semi-infinite domain, the analytical solution for this transient
diffusion problem is given by
<span class="math notranslate nohighlight">\(\phi = 1 - \erf(x/2\sqrt{D t})\)</span>. If the <a class="reference internal" href="../glossary.html#term-SciPy"><span class="xref std std-term">SciPy</span></a> library is available,
the result is tested against the expected profile:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">cellCenters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">timeStepDuration</span> <span class="o">*</span> <span class="n">steps</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span>
<span class="gp">... </span>    <span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erf</span> 
<span class="gp">... </span>    <span class="n">phiAnalytical</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">erf</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numerix</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">t</span><span class="p">))))</span> 
<span class="gp">... </span><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The SciPy library is not available to test the solution to </span><span class="se">\</span>
<span class="gp">... </span><span class="s2">the transient diffusion equation&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We then solve the equation by repeatedly looping in time:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">eqX</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
<span class="gp">... </span>              <span class="n">dt</span><span class="o">=</span><span class="n">timeStepDuration</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">phi</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phiAnalytical</span><span class="p">,</span> <span class="n">atol</span> <span class="o">=</span> <span class="mf">7e-4</span><span class="p">))</span> 
<span class="go">1</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Explicit transient diffusion. Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1Dexplicit.png"><img alt="solution to diffusion problem evolved by explicit time steps" class="align-center" src="../_images/mesh1Dexplicit.png" style="width: 90%;" /></a>
<hr class="docutils" />
<p>Although explicit finite differences are easy to program, we have just seen
that this 1D transient diffusion problem is limited to taking rather small
time steps. If, instead, we represent
Eq. <a class="reference internal" href="#equation-eq-diffusion-mesh1d-constantd">(1)</a>
as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">phi_new</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi_old</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> \
  <span class="o">+</span> <span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi_new</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi_new</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_new</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>it is possible to take much larger time steps. Because <code class="docutils literal notranslate"><span class="pre">phi_new</span></code> appears on
both the left and right sides of the equation, this form is called
“implicit”. In general, the “implicit” representation is much more
difficult to program than the “explicit” form that we just used, but in
<a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a>, all that is needed is to write</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">eqI</span> <span class="o">=</span> <span class="n">TransientTerm</span><span class="p">()</span> <span class="o">==</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
<p>reset the problem</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">valueRight</span><span class="p">)</span>
</pre></div>
</div>
<p>and rerun with much larger time steps</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">timeStepDuration</span> <span class="o">*=</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">steps</span> <span class="o">//=</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">eqI</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
<span class="gp">... </span>              <span class="n">dt</span><span class="o">=</span><span class="n">timeStepDuration</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">phi</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phiAnalytical</span><span class="p">,</span> <span class="n">atol</span> <span class="o">=</span> <span class="mf">2e-2</span><span class="p">))</span> 
<span class="go">1</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Implicit transient diffusion. Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1Dimplicit.png"><img alt="solution to diffusion problem evolved by implicit time steps" class="align-center" src="../_images/mesh1Dimplicit.png" style="width: 90%;" /></a>
<p>Note that although much larger <em>stable</em> timesteps can be taken with this
implicit version (there is, in fact, no limit to how large an implicit
timestep you can take for this particular problem), the solution is less
<em>accurate</em>. One way to achieve a compromise between <em>stability</em> and
<em>accuracy</em> is with the Crank-Nicholson scheme, represented by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">phi_new</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi_old</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> \
                <span class="p">((</span><span class="n">phi_new</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi_new</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_new</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                 <span class="o">+</span> <span class="p">(</span><span class="n">phi_old</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">phi_old</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_old</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
<p>which is essentially an average of the explicit and implicit schemes from
above. This can be rendered in <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a> as easily as</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">eqCN</span> <span class="o">=</span> <span class="n">eqX</span> <span class="o">+</span> <span class="n">eqI</span>
</pre></div>
</div>
<p>We again reset the problem</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">valueRight</span><span class="p">)</span>
</pre></div>
</div>
<p>and apply the Crank-Nicholson scheme until the end, when we apply one step
of the fully implicit scheme to drive down the error
(see, <em>e.g.</em>, section 19.2 of <span id="id1">[<a class="reference internal" href="../references.html#id10" title="William H. Press, Saul A. Teukolsky, William T. Vetterling, and Brian P. Flannery. Numerical Recipes in C: the Art of Scientific Computing. Cambridge University Press, 2nd edition, 1999.">24</a>]</span>).</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">eqCN</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">dt</span><span class="o">=</span><span class="n">timeStepDuration</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eqI</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
<span class="gp">... </span>          <span class="n">dt</span><span class="o">=</span><span class="n">timeStepDuration</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">phi</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phiAnalytical</span><span class="p">,</span> <span class="n">atol</span> <span class="o">=</span> <span class="mf">3e-3</span><span class="p">))</span> 
<span class="go">1</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Crank-Nicholson transient diffusion. Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<hr class="docutils" />
<p>As mentioned above, there is no stable limit to how large a time step can
be taken for the implicit diffusion problem. In fact, if the time evolution
of the problem is not interesting, it is possible to eliminate the time
step altogether by omitting the <a class="reference internal" href="fipy.terms.transientTerm.html#fipy.terms.transientTerm.TransientTerm" title="fipy.terms.transientTerm.TransientTerm"><code class="xref py py-class docutils literal notranslate"><span class="pre">TransientTerm</span></code></a>. The steady-state diffusion
equation</p>
<div class="math notranslate nohighlight">
\[D \nabla^2 \phi = 0\]</div>
<p>is represented in <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a> by</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy.solvers</span> <span class="kn">import</span> <span class="n">solver_suite</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">solver_suite</span> <span class="o">==</span> <span class="s2">&quot;pysparse&quot;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="n">LinearLUSolver</span>
<span class="gp">... </span>    <span class="n">solver</span> <span class="o">=</span> <span class="n">LinearLUSolver</span><span class="p">()</span>
<span class="gp">... </span><span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">solver</span> <span class="o">=</span> <span class="kc">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<p>The analytical solution to the steady-state problem is no longer an error
function, but simply a straight line, which we can confirm to a tolerance
of <span class="math notranslate nohighlight">\(10^{-10}\)</span>.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">L</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">dx</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">phi</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">valueLeft</span> <span class="o">+</span> <span class="p">(</span><span class="n">valueRight</span> <span class="o">-</span> <span class="n">valueLeft</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">L</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">rtol</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="n">atol</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">))</span>
<span class="go">1</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Implicit steady-state diffusion. Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1DsteadyState.png"><img alt="steady-state solution to diffusion problem" class="align-center" src="../_images/mesh1DsteadyState.png" style="width: 90%;" /></a>
<hr class="docutils" />
<p>Often, boundary conditions may be functions of another variable in the
system or of time.</p>
<p>For example, to have</p>
<div class="math notranslate nohighlight">
\[\begin{split}\phi = \begin{cases}
    (1 + \sin t) / 2 &amp;\text{on \( x = 0 \)} \\
    0 &amp;\text{on \( x = L \)} \\
\end{cases}\end{split}\]</div>
<p>we will need to declare time <span class="math notranslate nohighlight">\(t\)</span> as a <a class="reference internal" href="fipy.variables.variable.html#fipy.variables.variable.Variable" title="fipy.variables.variable.Variable"><code class="xref py py-class docutils literal notranslate"><span class="pre">Variable</span></code></a></p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">time</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>
</pre></div>
</div>
<p>and then declare our boundary condition as a function of this <a class="reference internal" href="fipy.variables.variable.html#fipy.variables.variable.Variable" title="fipy.variables.variable.Variable"><code class="xref py py-class docutils literal notranslate"><span class="pre">Variable</span></code></a></p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">phi</span><span class="o">.</span><span class="n">faceConstraints</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">valueLeft</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numerix</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">valueLeft</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesLeft</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesRight</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">eqI</span> <span class="o">=</span> <span class="n">TransientTerm</span><span class="p">()</span> <span class="o">==</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
<p>When we update <code class="docutils literal notranslate"><span class="pre">time</span></code> at each timestep, the left-hand boundary
condition will automatically update,</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="mf">.1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">time</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">eqI</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Time-dependent boundary condition. Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1DtimedBC.png"><img alt="solution to diffusion problem with a time-dependent Dirichlet boundary condition" class="align-center" src="../_images/mesh1DtimedBC.png" style="width: 90%;" /></a>
<hr class="docutils" />
<p>Many interesting problems do not have simple, uniform diffusivities. We consider a
steady-state diffusion problem</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot ( D \nabla \phi) = 0,\]</div>
<p>with a spatially varying diffusion coefficient</p>
<div class="math notranslate nohighlight">
\[\begin{split}D = \begin{cases}
1&amp; \text{for \( 0 &lt; x &lt; L / 4 \),} \\
0.1&amp; \text{for \( L / 4 \le x &lt; 3 L / 4 \),} \\
1&amp; \text{for \( 3 L / 4 \le x &lt; L \),}
\end{cases}\end{split}\]</div>
<p>and with boundary conditions
<span class="math notranslate nohighlight">\(\phi = 0\)</span> at <span class="math notranslate nohighlight">\(x = 0\)</span> and <span class="math notranslate nohighlight">\(D \frac{\partial \phi}{\partial x}
= 1\)</span> at <span class="math notranslate nohighlight">\(x = L\)</span>, where <span class="math notranslate nohighlight">\(L\)</span> is the length of the solution
domain. Exact numerical answers to this problem are found when the mesh
has cell centers that lie at <span class="math notranslate nohighlight">\(L / 4\)</span> and <span class="math notranslate nohighlight">\(3 L / 4\)</span>, or when the
number of cells in the mesh <span class="math notranslate nohighlight">\(N_i\)</span> satisfies <span class="math notranslate nohighlight">\(N_i = 4 i + 2\)</span>,
where <span class="math notranslate nohighlight">\(i\)</span> is an integer. The mesh we’ve been using thus far is
satisfactory, with <span class="math notranslate nohighlight">\(N_i = 50\)</span> and <span class="math notranslate nohighlight">\(i = 12\)</span>.</p>
<p>Because <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a> considers diffusion to be a flux from one cell to the next,
through the intervening face, we must define the non-uniform diffusion
coefficient on the mesh faces</p>
<div class="doctest highlight-default notranslate" id="index-2"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">D</span> <span class="o">=</span> <span class="n">FaceVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faceCenters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">D</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">L</span> <span class="o">/</span> <span class="mf">4.</span> <span class="o">&lt;=</span> <span class="n">X</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span> <span class="o">&lt;</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">L</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">))</span>
</pre></div>
</div>
<p>The boundary conditions are a fixed value of</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">valueLeft</span> <span class="o">=</span> <span class="mf">0.</span>
</pre></div>
</div>
<p>to the left and a fixed gradient of</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gradRight</span> <span class="o">=</span> <span class="mf">1.</span>
</pre></div>
</div>
<p>to the right:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;solution variable&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">faceGrad</span><span class="o">.</span><span class="n">constrain</span><span class="p">([</span><span class="n">gradRight</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesRight</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">valueLeft</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesLeft</span><span class="p">)</span>
</pre></div>
</div>
<p>We re-initialize the solution variable</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>and obtain the steady-state solution with one implicit solution step</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">eq</span> <span class="o">=</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">D</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solver</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">getDefaultSolver</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eq</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">)</span>
</pre></div>
</div>
<p>The analytical solution is simply</p>
<div class="math notranslate nohighlight">
\[\begin{split}\phi = \begin{cases}
x &amp; \text{for \( 0 &lt; x &lt; L/4 \),} \\
10 x - 9L/4 &amp; \text{for \( L/4 \le x &lt; 3 L / 4 \),} \\
x + 18 L / 4 &amp; \text{for \( 3 L / 4 \le x &lt; L \),}
\end{cases}\end{split}\]</div>
<p>or</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">cellCenters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiAnalytical</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiAnalytical</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">9.</span> <span class="o">*</span> <span class="n">L</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">L</span> <span class="o">/</span> <span class="mf">4.</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">L</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiAnalytical</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">18.</span> <span class="o">*</span> <span class="n">L</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">where</span><span class="o">=</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">L</span> <span class="o">/</span> <span class="mf">4.</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">phi</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phiAnalytical</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">))</span>
<span class="go">1</span>
</pre></div>
</div>
<p>And finally, we can plot the result</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">Viewer</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">phiAnalytical</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Non-uniform steady-state diffusion. Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1Dnon-uniform.png"><img alt="steady-state solution to diffusion problem with a non-uniform diffusivity" class="align-center" src="../_images/mesh1Dnon-uniform.png" style="width: 90%;" /></a>
<hr class="docutils" />
<p>Note that for problems involving heat transfer and other similar
conservation equations, it is important to ensure that we begin with
the correct form of the equation. For example, for heat transfer with
<span class="math notranslate nohighlight">\(\phi\)</span> representing the temperature,</p>
<div class="math notranslate nohighlight">
\[\frac{\partial}{\partial t} \left(\rho \hat{C}_p \phi\right) = \nabla \cdot [ k \nabla \phi ].\]</div>
<p>With constant and uniform density <span class="math notranslate nohighlight">\(\rho\)</span>, heat capacity <span class="math notranslate nohighlight">\(\hat{C}_p\)</span>
and thermal conductivity <span class="math notranslate nohighlight">\(k\)</span>, this is often written like Eq.
<a class="reference internal" href="#equation-eq-diffusion-mesh1d-constantd">(1)</a>, but replacing <span class="math notranslate nohighlight">\(D\)</span> with <span class="math notranslate nohighlight">\(\alpha =
\frac{k}{\rho \hat{C}_p}\)</span>. However, when these parameters vary either in position
or time, it is important to be careful with the form of the equation used. For
example, if <span class="math notranslate nohighlight">\(k = 1\)</span> and</p>
<div class="math notranslate nohighlight">
\[\begin{split}\rho \hat{C}_p = \begin{cases}
1&amp; \text{for \( 0 &lt; x &lt; L / 4 \),} \\
10&amp; \text{for \( L / 4 \le x &lt; 3 L / 4 \),} \\
1&amp; \text{for \( 3 L / 4 \le x &lt; L \),}
\end{cases},\end{split}\]</div>
<p>then we have</p>
<div class="math notranslate nohighlight">
\[\begin{split}\alpha = \begin{cases}
1&amp; \text{for \( 0 &lt; x &lt; L / 4 \),} \\
0.1&amp; \text{for \( L / 4 \le x &lt; 3 L / 4 \),} \\
1&amp; \text{for \( 3 L / 4 \le x &lt; L \),}
\end{cases}.\end{split}\]</div>
<p>However, using a <code class="docutils literal notranslate"><span class="pre">DiffusionTerm</span></code> with the same coefficient as that in the
section above is incorrect, as the steady state governing equation reduces to
<span class="math notranslate nohighlight">\(0 = \nabla^2\phi\)</span>, which results in a linear profile in 1D, unlike that
for the case above with spatially varying diffusivity. Similar care must be
taken if there is time dependence in the parameters in transient problems.</p>
<p>We can illustrate the differences with an example. We define field
variables for the correct and incorrect solution</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phiT</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;correct&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiF</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;incorrect&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiT</span><span class="o">.</span><span class="n">faceGrad</span><span class="o">.</span><span class="n">constrain</span><span class="p">([</span><span class="n">gradRight</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesRight</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiF</span><span class="o">.</span><span class="n">faceGrad</span><span class="o">.</span><span class="n">constrain</span><span class="p">([</span><span class="n">gradRight</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesRight</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiT</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">valueLeft</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesLeft</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiF</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">valueLeft</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesLeft</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiT</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiF</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The relevant parameters are</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">k</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">alpha_false</span> <span class="o">=</span> <span class="n">FaceVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faceCenters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">alpha_false</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">L</span> <span class="o">/</span> <span class="mf">4.</span> <span class="o">&lt;=</span> <span class="n">X</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span> <span class="o">&lt;</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">L</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eqF</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">alpha_false</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eqT</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">eqF</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phiF</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solver</span> <span class="o">=</span> <span class="n">eqT</span><span class="o">.</span><span class="n">getDefaultSolver</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eqT</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phiT</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">)</span>
</pre></div>
</div>
<p>Comparing to the correct analytical solution, <span class="math notranslate nohighlight">\(\phi = x\)</span></p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">cellCenters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiAnalytical</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">phiT</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phiAnalytical</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">))</span> 
<span class="go">1</span>
</pre></div>
</div>
<p>and finally, plot</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">Viewer</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">phiT</span><span class="p">,</span> <span class="n">phiF</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Non-uniform thermal conductivity. Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1Dalpha.png"><img alt="representation of difference between non-uniform alpha and D" class="align-center" src="../_images/mesh1Dalpha.png" style="width: 90%;" /></a>
<hr class="docutils" />
<p>Often, the diffusivity is not only non-uniform, but also depends on
the value of the variable, such that</p>
<div class="math notranslate nohighlight" id="equation-eq-diffusion-mesh1d-variabled">
<span class="eqno">(2)<a class="headerlink" href="#equation-eq-diffusion-mesh1d-variabled" title="Permalink to this equation">¶</a></span>\[\frac{\partial \phi}{\partial t} = \nabla \cdot [ D(\phi) \nabla \phi].\]</div>
<p>With such a non-linearity, it is generally necessary to “sweep” the
solution to convergence. This means that each time step should be
calculated over and over, using the result of the previous sweep to update
the coefficients of the equation, without advancing in time. In <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a>, this
is accomplished by creating a solution variable that explicitly retains its
“old” value by specifying <code class="docutils literal notranslate"><span class="pre">hasOld</span></code> when you create it. The variable does
not move forward in time until it is explicitly told to <code class="docutils literal notranslate"><span class="pre">updateOld()</span></code>. In
order to compare the effects of different numbers of sweeps, let us create
a list of variables: <code class="docutils literal notranslate"><span class="pre">phi[0]</span></code> will be the variable that is actually being
solved and <code class="docutils literal notranslate"><span class="pre">phi[1]</span></code> through <code class="docutils literal notranslate"><span class="pre">phi[4]</span></code> will display the result of taking the
corresponding number of sweeps (<code class="docutils literal notranslate"><span class="pre">phi[1]</span></code> being equivalent to not sweeping
at all).</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">valueLeft</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">valueRight</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>    <span class="n">CellVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;solution variable&quot;</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="n">value</span><span class="o">=</span><span class="n">valueRight</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="n">hasOld</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">CellVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;1 sweep&quot;</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">CellVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;2 sweeps&quot;</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">CellVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;3 sweeps&quot;</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">CellVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;4 sweeps&quot;</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">)</span>
<span class="gp">... </span><span class="p">]</span>
</pre></div>
</div>
<p>If, for example,</p>
<div class="math notranslate nohighlight">
\[D = D_0 (1 - \phi)\]</div>
<p>we would simply write
Eq. <a class="reference internal" href="#equation-eq-diffusion-mesh1d-variabled">(2)</a>
as</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">D0</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eq</span> <span class="o">=</span> <span class="n">TransientTerm</span><span class="p">()</span> <span class="o">==</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">D0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because of the non-linearity, the Crank-Nicholson scheme does not work
for this problem.</p>
</div>
<p>We apply the same boundary conditions that we used for the uniform
diffusivity cases</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">valueRight</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesRight</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">valueLeft</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesLeft</span><span class="p">)</span>
</pre></div>
</div>
<p>Although this problem does not have an exact transient solution, it
can be solved in steady-state, with</p>
<div class="math notranslate nohighlight">
\[\phi(x) = 1 - \sqrt{\frac{x}{L}}\]</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">cellCenters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phiAnalytical</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">numerix</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">L</span><span class="p">))</span>
</pre></div>
</div>
<p>We create a viewer to compare the different numbers of sweeps with the
analytical solution from before.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span> <span class="o">=</span> <span class="n">Viewer</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="n">phi</span> <span class="o">+</span> <span class="p">[</span><span class="n">phiAnalytical</span><span class="p">],</span>
<span class="gp">... </span>                    <span class="n">datamin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">datamax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<p>As described above, an inner “sweep” loop is generally required for
the solution of non-linear or multiple equation sets. Often a
conditional is required to exit this “sweep” loop given some
convergence criteria. Instead of using the <a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.solve" title="fipy.terms.term.Term.solve"><code class="xref py py-meth docutils literal notranslate"><span class="pre">solve()</span></code></a>
method equation, when sweeping, it is often useful to call
<a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.sweep" title="fipy.terms.term.Term.sweep"><code class="xref py py-meth docutils literal notranslate"><span class="pre">sweep()</span></code></a> instead. The
<a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.sweep" title="fipy.terms.term.Term.sweep"><code class="xref py py-meth docutils literal notranslate"><span class="pre">sweep()</span></code></a> method behaves the same way as
<a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.solve" title="fipy.terms.term.Term.solve"><code class="xref py py-meth docutils literal notranslate"><span class="pre">solve()</span></code></a>, but returns the residual that can then be
used as part of the exit condition.</p>
<p>We now repeatedly run the problem with increasing numbers of
sweeps.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">sweeps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">valueRight</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
<span class="gp">... </span>        <span class="c1"># only move forward in time once per time step</span>
<span class="gp">... </span>        <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">updateOld</span><span class="p">()</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="c1"># but &quot;sweep&quot; many times per time step</span>
<span class="gp">... </span>        <span class="k">for</span> <span class="n">sweep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sweeps</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">res</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="gp">... </span>                           <span class="n">dt</span><span class="o">=</span><span class="n">timeStepDuration</span><span class="p">)</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>            <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="c1"># copy the final result into the appropriate display variable</span>
<span class="gp">... </span>    <span class="n">phi</span><span class="p">[</span><span class="n">sweeps</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="gp">... </span>        <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Implicit variable diffusivity. </span><span class="si">%d</span><span class="s2"> sweep(s). </span><span class="se">\</span>
<span class="gp">... </span><span class="s2">Residual = </span><span class="si">%f</span><span class="s2">. Press &lt;return&gt; to proceed...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sweeps</span><span class="p">,</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">res</span><span class="p">))))</span>
</pre></div>
</div>
<p>As can be seen, sweeping does not dramatically change the result, but the
“residual” of the equation (a measure of how accurately it has been solved)
drops about an order of magnitude with each additional sweep.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Choosing an optimal balance between the number of time steps, the number
of sweeps, the number of solver iterations, and the solver tolerance is
more art than science and will require some experimentation on your part
for each new problem.</p>
</div>
<p>Finally, we can increase the number of steps to approach equilibrium, or we
can just solve for it directly</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">eq</span> <span class="o">=</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">D0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solver</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">getDefaultSolver</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">valueRight</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="mf">1e+10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">while</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">res</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="gp">... </span>                   <span class="n">dt</span><span class="o">=</span><span class="n">timeStepDuration</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phiAnalytical</span><span class="p">,</span> <span class="n">atol</span> <span class="o">=</span> <span class="mf">1e-1</span><span class="p">))</span>
<span class="go">1</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Implicit variable diffusivity - steady-state. </span><span class="se">\</span>
<span class="gp">... </span><span class="s2">Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1Dvariable.png"><img alt="solution to a diffusion problem a non-linear diffusivity" class="align-center" src="../_images/mesh1Dvariable.png" style="width: 90%;" /></a>
<hr class="docutils" />
<p>Fully implicit solutions are not without their pitfalls, particularly in steady
state. Consider a localized block of material diffusing in a closed box.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\phi$&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">L</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">L</span><span class="o">/</span><span class="mf">10.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">L</span><span class="o">/</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">L</span><span class="o">/</span><span class="mf">10.</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span> <span class="o">=</span> <span class="n">Viewer</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">datamin</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">datamax</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1D-noflux_initial.png"><img alt="initial condition for no-flux boundary conditions" class="align-center" src="../_images/mesh1D-noflux_initial.png" style="width: 90%;" /></a>
<p>We assign no explicit boundary conditions, leaving the default no-flux boundary
conditions, and solve</p>
<div class="math notranslate nohighlight">
\[\partial\phi/\partial t = \nabla\cdot(D\nabla\phi)\]</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">D</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eq</span> <span class="o">=</span> <span class="n">TransientTerm</span><span class="p">()</span> <span class="o">==</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">*</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">steps</span> <span class="o">=</span> <span class="mi">200</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">eq</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;No-flux - transient. </span><span class="se">\</span>
<span class="gp">... </span><span class="s2">Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1D-noflux_transient.png"><img alt="long-time solution for no-flux boundary conditions" class="align-center" src="../_images/mesh1D-noflux_transient.png" style="width: 90%;" /></a>
<p>and see that <span class="math notranslate nohighlight">\(\phi\)</span> dissipates to the expected average value of 0.2 with
reasonable accuracy.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">numerix</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">4e-5</span><span class="p">))</span>
<span class="go">True</span>
</pre></div>
</div>
<p>If we reset the initial condition</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">L</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">L</span><span class="o">/</span><span class="mf">10.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">L</span><span class="o">/</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">L</span><span class="o">/</span><span class="mf">10.</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<p>and solve the steady-state problem</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">)</span>
<span class="gp">... </span><span class="k">except</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;No-flux - steady-state failure. </span><span class="se">\</span>
<span class="gp">... </span><span class="s2">Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">numerix</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">))</span> 
<span class="go">False</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1D-noflux_steady_fail.png"><img alt="(failed) steady-state solution for no-flux boundary conditions" class="align-center" src="../_images/mesh1D-noflux_steady_fail.png" style="width: 90%;" /></a>
<p>Depending on the solver, we find that the value may be uniformly zero,
infinity, or NaN, or the solver may just fail!
What happened to our no-flux boundary conditions?
Trilinos actually manages to get the correct solution, but this should not
be relied on; this problem has an infinite number of solutions.</p>
<p>The problem is that in the implicit discretization of <span class="math notranslate nohighlight">\(\nabla\cdot(D\nabla\phi) = 0\)</span>,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{vmatrix}
\frac{D}{{\Delta x}^2} &amp; -\frac{D}{{\Delta x}^2} &amp; &amp; &amp; &amp; &amp; \\\\[1em]
\ddots &amp; \ddots &amp; \ddots &amp; &amp; &amp; &amp; \\[1em]
&amp; -\frac{D}{{\Delta x}^2} &amp; \frac{2 D}{{\Delta x}^2} &amp; -\frac{D}{{\Delta x}^2} &amp; &amp; &amp; \\\\[1em]
&amp; &amp; -\frac{D}{{\Delta x}^2} &amp; \frac{2 D}{{\Delta x}^2} &amp; -\frac{D}{{\Delta x}^2} &amp; &amp; \\\\[1em]
&amp; &amp; &amp; -\frac{D}{{\Delta x}^2} &amp; \frac{2 D}{{\Delta x}^2} &amp; -\frac{D}{{\Delta x}^2} &amp; \\\\[1em]
&amp; &amp; &amp; &amp; \ddots &amp; \ddots &amp; \ddots \\\\[1em]
&amp; &amp; &amp; &amp; &amp; -\frac{D}{{\Delta x}^2} &amp; \frac{D}{{\Delta x}^2} \\\\[1em]
\end{vmatrix}
\begin{vmatrix}
\phi^\text{new}_{0} \\\\[1em]
\vdots \\[1em]
\phi^\text{new}_{j-1} \\\\[1em]
\phi^\text{new}_{j} \\\\[1em]
\phi^\text{new}_{j+1} \\\\[1em]
\vdots \\\\[1em]
\phi^\text{new}_{N-1}
\end{vmatrix}
=
\begin{vmatrix}
0 \\\\[1em]
\vdots \\\\[1em]
0 \\\\[1em]
0 \\\\[1em]
0 \\\\[1em]
\vdots \\\\[1em]
0
\end{vmatrix}\end{split}\]</div>
<p>the initial condition <span class="math notranslate nohighlight">\(\phi^\text{old}\)</span> no longer appears and
<span class="math notranslate nohighlight">\(\phi = 0\)</span> is a perfectly legitimate solution to this matrix equation.</p>
<p>The solution is to run the transient problem and to take one enormous time step</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phi</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">L</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">L</span><span class="o">/</span><span class="mf">10.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">L</span><span class="o">/</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">L</span><span class="o">/</span><span class="mf">10.</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">eq</span> <span class="o">=</span> <span class="p">(</span><span class="n">TransientTerm</span><span class="p">()</span> <span class="o">==</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
</pre></div>
</div>
<p>The initial residual is much larger than the norm of the right-hand-side
vector, so we use <cite>“initial”</cite> tolerance scaling.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">solver</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">getDefaultSolver</span><span class="p">(</span><span class="n">criterion</span><span class="o">=</span><span class="s2">&quot;initial&quot;</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eq</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1e6</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;No-flux - steady-state. </span><span class="se">\</span>
<span class="gp">... </span><span class="s2">Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">numerix</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">))</span>
<span class="go">True</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/mesh1D-noflux_steady.png"><img alt="steady-state solution for no-flux boundary conditions" class="align-center" src="../_images/mesh1D-noflux_steady.png" style="width: 90%;" /></a>
<hr class="docutils" />
<p>If this example had been written primarily as a script, instead of as
documentation, we would delete every line that does not begin with
either “<code class="docutils literal notranslate"><span class="pre">&gt;&gt;&gt;</span></code>” or “<code class="docutils literal notranslate"><span class="pre">...</span></code>”, and then delete those prefixes from the
remaining lines, leaving:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## This script was derived from</span>
<span class="c1">## &#39;examples/diffusion/mesh1D.py&#39;</span>

<span class="n">nx</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">dx</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">Grid1D</span><span class="p">(</span><span class="n">nx</span> <span class="o">=</span> <span class="n">nx</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span><span class="p">)</span>
<span class="n">phi</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;solution variable&quot;</span><span class="p">,</span>
                   <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span>
                   <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">eq</span> <span class="o">=</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">D0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">valueRight</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="mf">1e+10</span>
<span class="k">while</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                   <span class="n">dt</span><span class="o">=</span><span class="n">timeStepDuration</span><span class="p">)</span>

<span class="nb">print</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phiAnalytical</span><span class="p">,</span> <span class="n">atol</span> <span class="o">=</span> <span class="mf">1e-1</span><span class="p">)</span>
<span class="c1"># Expect:</span>
<span class="c1"># 1</span>
<span class="c1">#</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Implicit variable diffusivity - steady-state. </span><span class="se">\</span>
<span class="s2">Press &lt;return&gt; to proceed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Your own scripts will tend to look like this, although you can always write
them as doctest scripts if you choose.  You can obtain a plain script
like this from some <cite>…/example.py</cite> by typing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python setup.py copy_script --From .../example.py --To myExample.py
</pre></div>
</div>
<p>at the command line.</p>
<p>Most of the <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a> examples will be a
mixture of plain scripts and doctest documentation/tests.</p>
</section>


                <div class='last-updated'>
                Last updated on Jul 10, 2025.
                Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.1.2.
                </div>
              </div>
  </div>  
  <aside class="nist-page__region nist-page__region--sidebar-second tablet-lg:grid-col-4">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

<strong>FiPy: A Finite Volume PDE Solver Using Python</strong><br />
Version 3.4.5+370.g2caf71221

<div class="sphinxsidebarsection">
  <h4>Previous topic</h4>
  <p class="topless"><a href="examples.diffusion.explicit.tri2D.html"
                        title="previous chapter">examples.diffusion.explicit.tri2D</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="examples.diffusion.mesh20x20.html"
                        title="next chapter">examples.diffusion.mesh20x20</a></p>
</div>
  <div class="sphinxsidebarsection">
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/generated/examples.diffusion.mesh1D.rst.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  </div>
<div class="sphinxsidebarsection">
<div id="searchbox" style="display: none" role="search">
  <div data-layout-content-preview-placeholder-label="&quot;Sphinx
  Search&quot; field" class="nist-block nist-block--search">
  <h2 id="searchlabel">Quick search</h2>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
  </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
</div>
<div class="sphinxsidebarsection" id="contact-wrapper">
  
        <div data-layout-content-preview-placeholder-label="&quot;Related
        organization tree&quot; views block" class="nist-block nist-block--org">
          
          <h2 class="nist-block__title">Organizations</h2>
              
              <div class="views-element-container"><div
              class="js-view-dom-id-70b0923f677edbe3dda361030ef8dc373cd0ca94065c39cfd81338de767f1019">

            <div class="nist-related-orgs"><div class="term-tree-list"><ul
            class="term"><li class="selected"><a
            href="https://www.nist.gov/nist-organizations/nist-headquarters" hreflang="en">NIST
            Headquarters</a><ul class="term"><li class="selected"><a
            href="https://www.nist.gov/nist-organizations/nist-headquarters/laboratory-programs"
            hreflang="en">Laboratory Programs</a><ul class="term"><li
            class="selected"><a
            href="https://www.nist.gov/nist-organizations/nist-headquarters/laboratory-programs/material-measurement-laboratory"
            hreflang="en">Material Measurement Laboratory</a>
			<ul
			class="term"><li
			class="selected"><a href="https://www.nist.gov/mml/msed"
			hreflang="en">Materials Science and Engineering
			Division</a></li><li
			class="selected"><a href="https://www.nist.gov/mml/ctcms"
			hreflang="en">Center for Theoretical and
			              Computational Materials Science</a></li></ul>
                          </li></ul></li></ul></li></ul></div></div>
          <div class="nist-related-orgs"></div>
          <div class="nist-related-orgs"></div>



        </div>
        </div>

          </div>


          <div data-layout-content-preview-placeholder-label="&quot;NIST
          Staff&quot; field" class="nist-block nist-block--contact">

          <h2 class="nist-block__title">NIST Staff</h2>

                  <div class="nist-field nist-field--label-hidden
                  nist-field--link-list entity-reference nist-field__items
                  nist-field--no-margin">
                            <div class="nist-field__item
                            nist-field--no-margin"><a
                            href="https://www.nist.gov/people/jonathan-e-guyer"
                            hreflang="en">Jonathan E. Guyer</a></div>
                                <div class="nist-field__item
                                nist-field--no-margin"><a
                                href="https://www.nist.gov/people/daniel-wheeler"
                                hreflang="en">Daniel Wheeler</a></div>
                                <div class="nist-field__item
                                nist-field--no-margin"><a
                                href="https://www.nist.gov/people/james-warren"
                                hreflang="en">James A. Warren</a></div>
                  </div>


          </div>

          <div data-layout-content-preview-placeholder-label="&quot;Contact&quot; field"
          class="nist-block nist-block--contact nist-block--mail">

          <h2 class="nist-block__title">
          <a class="" href="../docs/source/CONTACT.html" style="">Contact</a>
          </h2>

          </div>

</div>
        </div>
      </div>
      <div class="clearer"></div>
  </aside>
        </div>
      </div>

      <div class="panel-region--postface">
      <div class="inner region-inner inside">
        
<div class="pane pane--nist-node-date-pane" >

    </div>
      </div>
    </div>

        </section>
        </div>
      </div>

      </div>  
    </div>          

    </div>

  </div>

</div>


  


  <!-- Taken from https://www.filamentgroup.com/lab/html-includes/#another-demo%3A-including-another-html-file -->
  <iframe src="../_static/ntd2d_menu.html" onload="this.before((this.contentDocument.body||this.contentDocument).children[0]);this.remove()"></iframe>
    </div>
  </body>
</html>