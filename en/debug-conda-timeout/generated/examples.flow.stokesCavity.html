
<!DOCTYPE html>


<!--[if IEMobile 7]><html class="iem7 no-js"  lang="en" dir="ltr"><![endif]-->
<!--[if lte IE 6]><html class="lt-ie9 lt-ie8 lt-ie7 no-js"  lang="en" dir="ltr"><![endif]-->
<!--[if (IE 7)&(!IEMobile)]><html class="lt-ie9 lt-ie8 no-js"  lang="en" dir="ltr"><![endif]-->
<!--[if IE 8]><html class="lt-ie9 no-js"  lang="en" dir="ltr"><![endif]-->
<!--[if (gte IE 9)|(gt IEMobile 7)]><!--><html class="no-js"  lang="en" dir="ltr" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# book: http://ogp.me/ns/book# profile: http://ogp.me/ns/profile# video: http://ogp.me/ns/video# product: http://ogp.me/ns/product# content: http://purl.org/rss/1.0/modules/content/ dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/ rdfs: http://www.w3.org/2000/01/rdf-schema# sioc: http://rdfs.org/sioc/ns# sioct: http://rdfs.org/sioc/types# skos: http://www.w3.org/2004/02/skos/core# xsd: http://www.w3.org/2001/XMLSchema#"><!--<![endif]-->

  <head>
<meta charset="utf-8" />
<link rel="shortcut icon" href="https://www.nist.gov/sites/all/themes/nist_style/favicon.ico" type="image/vnd.microsoft.icon" />
<script type="text/x-mathjax-config">MathJax.Hub.Config({
  extensions: ['tex2jax.js'],
  jax: ['input/TeX','output/HTML-CSS'],
  tex2jax: {
    inlineMath: [ ['$$','$$'], ['\\(','\\)'] ],
    processEscapes: true,
    processClass: 'tex2jax',
    ignoreClass: 'html'
  },
  showProcessingMessages: false,
  messageStyle: 'none'
});
</script>
<meta name="MobileOptimized" content="width">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">

      <!--[if lt IE 9]>
    <script src="https://www.nist.gov/sites/all/themes/zen/js/html5-respond.js"></script>
    <![endif]-->
    <!--[if (gte IE 6)&(lte IE 8)]>
  <script type="text/javascript" src="https://www.nist.gov/sites/all/themes/nist_style/js/selectivizr-min.js"></script>
  <![endif]--><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>examples.flow.stokesCavity &#8212; FiPy 3.4.5+28.g44ba2a228 documentation</title>
    <link rel="stylesheet" href="../_static/ntd2d.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/ntd2d.css?v=de7af573" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=9f3ae26b"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="canonical" href="https://pages.nist.gov/fipy/en/latest/generated/examples.flow.stokesCavity.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="FiPy 3.4.5+28.g44ba2a228 documentation" href="../contents.html" />
    <link rel="up" title="examples.flow" href="examples.flow.html" />
    <link rel="next" title="examples.flow.test" href="examples.flow.test.html" />
    <link rel="prev" title="examples.flow" href="examples.flow.html" />
  
 


  <link rel="stylesheet" href="https://pages.nist.gov/nist-header-footer/css/nist-combined.css">
  <script src="https://code.jquery.com/jquery-3.6.2.min.js" type="text/javascript" defer="defer"></script>
  <script src="https://pages.nist.gov/nist-header-footer/js/nist-header-footer.js" type="text/javascript" defer="defer"></script>


  </head>
<!--  <body role="document">-->
  <body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-414011 node-type-software hide-breadcrumb section-services-resources page-panels is-panel" role="document">
      <div id="page" class="mini-header">



    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="examples.flow.test.html" title="examples.flow.test"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="examples.flow.html" title="examples.flow"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html"><img src="../_static/fipy.png" alt="FiPy logo"
                 style="vertical-align: middle; margin-top: -1px"/>
        FiPy</a> &gt;</li>

          <li class="nav-item nav-item-1"><a href="../API.html" ><code class="xref py py-mod docutils literal notranslate"><span class="pre">fipy</span></code> Package Documentation</a> &gt;</li>
          <li class="nav-item nav-item-2"><a href="examples.html" >examples</a> &gt;</li>
          <li class="nav-item nav-item-3"><a href="examples.flow.html" accesskey="U">examples.flow</a> &gt;</li> 
      </ul>
    </div>

  <div id="main" class="clearfix" role="main" tabindex="-1">
    <div class="main__inner">
      <div class="page-info">
        <a id="main-content"></a>
      </div>

      <div class="document">
        <div class="documentwrapper">

      <div id="content" class="column">
      <div id="block-nist-www-content" class="nist-block">
        <section class="nist-page__content usa-section clearfix">

         

        <div class="grid-container margin-top-4">
        <div class="grid-row grid-gap-6">

  <div class="nist-page__region nist-page__region--content tablet-lg:grid-col-8">
              <div class="body" role="main">
		
  <section id="module-examples.flow.stokesCavity">
<span id="examples-flow-stokescavity"></span><h1>examples.flow.stokesCavity<a class="headerlink" href="#module-examples.flow.stokesCavity" title="Permalink to this heading">¶</a></h1>
<p>Solve the Navier-Stokes equation in the viscous limit.</p>
<p>Many thanks to Benny Malengier &lt;<a class="reference external" href="mailto:bm&#37;&#52;&#48;cage&#46;ugent&#46;be">bm<span>&#64;</span>cage<span>&#46;</span>ugent<span>&#46;</span>be</a>&gt; for reworking this example and
actually making it work correctly… see <a class="reference external" href="https://github.com/usnistgov/fipy/issues/209">#209</a></p>
<p>This example is an implementation of a rudimentary Stokes solver on a collocated
grid.  It solves the Navier-Stokes equation in the viscous limit,</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \left( \mu \nabla \vec{u} \right) = \nabla p\]</div>
<p>and the
continuity equation,</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \vec{u} = 0\]</div>
<p>where <span class="math notranslate nohighlight">\(\vec{u}\)</span> is the fluid velocity, <span class="math notranslate nohighlight">\(p\)</span> is the pressure and <span class="math notranslate nohighlight">\(\mu\)</span>
is the viscosity.  The domain in this example is a square cavity
of unit dimensions with a moving lid of unit speed.  This example
uses the SIMPLE algorithm with Rhie-Chow interpolation for collocated grids to solve
the pressure-momentum coupling. Some of the details of the
algorithm will be highlighted below but a good reference for this
material is Ferziger and Peric <span id="id2">[<a class="reference internal" href="../references.html#id29" title="J. H. Ferziger and M. Perić. Computational Methods for Fluid Dynamics. Springer, 1996.">25</a>]</span> and Rossow <span id="id3">[<a class="reference internal" href="../references.html#id30" title="C.-C. Rossow. A blended pressure/density based method for the computation of incompressible and compressible flows. Journal of Computational Physics, 185(2):375-398, 2003. doi:10.1016/S0021-9991(02)00059-1.">26</a>]</span>. The
solution has a high degree of error close to the corners of the
domain for the pressure but does a reasonable job of predicting
the velocities away from the boundaries. A number of aspects of
<a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a> need to be improved to have a first class flow
solver. These include, higher order spatial diffusion terms,
proper wall boundary conditions, improved mass flux evaluation and
extrapolation of cell values to the boundaries using gradients.</p>
<p>In the table below a comparison is made with the <a class="reference external" href="http://www.dolfyn.net/">Dolfyn</a> open source
code on a 100 by 100 grid. The table shows the frequency of values
that fall within the given error confidence bands. <a class="reference external" href="http://www.dolfyn.net/">Dolfyn</a> has the
added features described above. When these features are switched off
the results of <a class="reference external" href="http://www.dolfyn.net/">Dolfyn</a>
and <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a> are identical.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>% frequency of cells</p></th>
<th class="head"><p>x-velocity error (%)</p></th>
<th class="head"><p>y-velocity error (%)</p></th>
<th class="head"><p>pressure error (%)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>90</p></td>
<td><p><span class="math notranslate nohighlight">\(&lt;0.1\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(&lt; 0.1\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(&lt; 5\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>0.1 to 0.6</p></td>
<td><p>0.1 to 0.3</p></td>
<td><p>5 to 11</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>0.6 to 7</p></td>
<td><p>0.3 to 4</p></td>
<td><p>11 to 35</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>7 to 96</p></td>
<td><p>4 to 80</p></td>
<td><p>35 to 179</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p><span class="math notranslate nohighlight">\(&gt; 96\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(&gt; 80\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(&gt; 179\)</span></p></td>
</tr>
</tbody>
</table>
<p>To start, some parameters are declared.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy</span> <span class="kn">import</span> <span class="n">CellVariable</span><span class="p">,</span> <span class="n">FaceVariable</span><span class="p">,</span> <span class="n">Grid2D</span><span class="p">,</span> <span class="n">DiffusionTerm</span><span class="p">,</span> <span class="n">Viewer</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy.tools</span> <span class="kn">import</span> <span class="n">numerix</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">L</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">N</span> <span class="o">=</span> <span class="mi">50</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dL</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">N</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">viscosity</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">U</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1">#0.8 for pressure and 0.5 for velocity are typical relaxation values for SIMPLE</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pressureRelaxation</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">velocityRelaxation</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">sweeps</span> <span class="o">=</span> <span class="mi">300</span>
<span class="gp">... </span><span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">sweeps</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>
</div>
<p>Build the mesh.</p>
<div class="doctest highlight-default notranslate" id="index-0"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mesh</span> <span class="o">=</span> <span class="n">Grid2D</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dL</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dL</span><span class="p">)</span>
</pre></div>
</div>
<p>Declare the variables.</p>
<div class="doctest highlight-default notranslate" id="index-1"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pressure</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pressure&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pressureCorrection</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xVelocity</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X velocity&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yVelocity</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y velocity&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The velocity is required as a rank-1
<a class="reference internal" href="fipy.variables.faceVariable.html#fipy.variables.faceVariable.FaceVariable" title="fipy.variables.faceVariable.FaceVariable"><code class="xref py py-class docutils literal notranslate"><span class="pre">FaceVariable</span></code></a> for calculating the mass
flux. This is required by the Rhie-Chow correction to avoid pressure/velocity
decoupling.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">velocity</span> <span class="o">=</span> <span class="n">FaceVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Build the Stokes equations in the cell centers.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">xVelocityEq</span> <span class="o">=</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">viscosity</span><span class="p">)</span> <span class="o">-</span> <span class="n">pressure</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yVelocityEq</span> <span class="o">=</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">viscosity</span><span class="p">)</span> <span class="o">-</span> <span class="n">pressure</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
</pre></div>
</div>
<p>In this example the SIMPLE algorithm is used to couple the
pressure and momentum equations. Let us assume we have solved the
discretized momentum equations using a guessed pressure field
<span class="math notranslate nohighlight">\(p^{\ast}\)</span> to obtain a velocity field <span class="math notranslate nohighlight">\(\vec{u}^{\ast}\)</span>. That is
<span class="math notranslate nohighlight">\(\vec{u}^{\ast}\)</span> is found from</p>
<div class="math notranslate nohighlight">
\[a_P \vec{u}^{\ast}_P = \sum_f a_A \vec{u}^{\ast}_A - V_P (\nabla p^{\ast})_P\]</div>
<p>We would like to somehow correct these initial fields to satisfy both the
discretized momentum and continuity equations. We now try to
correct these initial fields with a correction such that
<span class="math notranslate nohighlight">\(\vec{u} = \vec{u}^{\ast} + \vec{u}'\)</span> and <span class="math notranslate nohighlight">\(p = p^{\ast} + p'\)</span>, where
<span class="math notranslate nohighlight">\(\vec{u}\)</span> and <span class="math notranslate nohighlight">\(p\)</span> now satisfy the momentum and continuity
equations. Substituting the exact solution into the equations we
obtain,</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \left( \mu \nabla \vec{u}' \right) = \nabla p'\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \vec{u}^{\ast} + \nabla \cdot \vec{u}' = 0\]</div>
<p>We now use the discretized form of the equations to write the velocity
correction in terms of the pressure correction. The discretized
form of the above equation results in an equation for <span class="math notranslate nohighlight">\(p = p'\)</span>,</p>
<div class="math notranslate nohighlight">
\[a_P \vec{u}'_P = \sum_f a_A \vec{u}'_A - V_P (\nabla p')_P\]</div>
<p>where notation from <a class="reference internal" href="../numerical/discret.html#section-linear-equations"><span class="std std-ref">Linear Equations</span></a> is used. The SIMPLE
algorithm drops the second term in the above equation to leave,</p>
<div class="math notranslate nohighlight">
\[\vec{u}'_{P} = - \frac{ V_P (\nabla p')_P }{ a_P }\]</div>
<p>By substituting the above expression into the continuity equations we
obtain the pressure correction equation,</p>
<div class="math notranslate nohighlight">
\[\nabla \frac{V_P}{a_P} \cdot \nabla p' = \nabla \cdot \vec{u}^{\ast}\]</div>
<p>In the discretized version of the above equation <span class="math notranslate nohighlight">\(V_P / a_P\)</span> is
approximated at the face by <span class="math notranslate nohighlight">\(A_f d_{AP} / (a_P)_f\)</span>. In <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a> the
pressure correction equation can be written as,</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ap</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">coeff</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span> <span class="n">ap</span><span class="o">.</span><span class="n">arithmeticFaceValue</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">_faceAreas</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">_cellDistances</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pressureCorrectionEq</span> <span class="o">=</span> <span class="n">DiffusionTerm</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="n">coeff</span><span class="p">)</span> <span class="o">-</span> <span class="n">velocity</span><span class="o">.</span><span class="n">divergence</span>
</pre></div>
</div>
<p>Above would work good on a staggered grid, however, on a colocated grid as <a class="reference internal" href="../glossary.html#term-FiPy"><span class="xref std std-term">FiPy</span></a>
uses, the term
<code class="docutils literal notranslate"><span class="pre">velocity</span></code>.<a class="reference internal" href="fipy.variables.faceVariable.html#fipy.variables.faceVariable.FaceVariable.divergence" title="fipy.variables.faceVariable.FaceVariable.divergence"><code class="xref py py-attr docutils literal notranslate"><span class="pre">divergence</span></code></a> will
cause oscillations in the pressure solution as velocity is a face variable. We
can apply the Rhie-Chow correction terms for this. In this an intermediate
velocity term <span class="math notranslate nohighlight">\(u^\diamond\)</span> is considered which does not contain the
pressure corrections:</p>
<div class="math notranslate nohighlight">
\[\vec{u}^{\diamond}_P = \vec{u}^{\ast}_P + \frac{V_P}{a_P} (\nabla p^{\ast})_P
= \sum_f \frac{a_A}{a_P} \vec{u}^{\ast}_A\]</div>
<p>This velocity is interpolated at the edges, after which the pressure correction
term is added again, but now considered at the edge:</p>
<div class="math notranslate nohighlight">
\[\vec{u}_f = \frac{1}{2}(\vec{u}^{\diamond}_L + \vec{u}^{\diamond}_R))
- \left(\frac{V}{a_P}\right)_{\mathrm{avg\ L,R}} (\nabla p^{\ast}_f)\]</div>
<p>where <span class="math notranslate nohighlight">\(\left(\frac{V}{a_P}\right)_{\mathrm{avg\ L,R}}\)</span>  is assumed a good approximation at the edge. Here L
and R denote the two cells adjacent to the face. Expanding the
not calculated terms we arrive at</p>
<div class="math notranslate nohighlight">
\[\vec{u}_f = \frac{1}{2}(\vec{u}^{\ast}_L + \vec{u}^{\ast}_R))
+ \frac{1}{2}\left(\frac{V}{a_P}\right)_{\mathrm{avg\ L,R}} (\nabla p^{\ast}_L+ \nabla p^{\ast}_R)
- \left(\frac{V}{a_P}\right)_{\mathrm{avg\ L,R}} (\nabla p^{\ast}_f)\]</div>
<p>where we have replaced the coefficients of the cell pressure gradients by
an averaged value over the edge.
This formula has the consequence that the velocity on a face depends not only
on the pressure of the adjacent cells, but also on the cells further away, which
removes the unphysical pressure oscillations. We start by introducing needed
terms</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fipy.variables.faceGradVariable</span> <span class="kn">import</span> <span class="n">_FaceGradVariable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">volume</span> <span class="o">=</span> <span class="n">CellVariable</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">cellVolumes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">contrvolume</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">arithmeticFaceValue</span>
</pre></div>
</div>
<p>And set up the velocity with this formula in the SIMPLE loop.
Now, set up the no-slip boundary conditions</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">xVelocity</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesRight</span> <span class="o">|</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesLeft</span> <span class="o">|</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesBottom</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xVelocity</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesTop</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yVelocity</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">exteriorFaces</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faceCenters</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pressureCorrection</span><span class="o">.</span><span class="n">constrain</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesLeft</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Y</span> <span class="o">&lt;</span> <span class="n">dL</span><span class="p">))</span>
</pre></div>
</div>
<p>Set up the viewers,</p>
<div class="doctest highlight-default notranslate" id="index-2"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">viewer</span> <span class="o">=</span> <span class="n">Viewer</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="n">xVelocity</span><span class="p">,</span> <span class="n">yVelocity</span><span class="p">,</span> <span class="n">velocity</span><span class="p">),</span>
<span class="gp">... </span>               <span class="n">xmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>Below, we iterate for a set number of sweeps. We use the
<a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.sweep" title="fipy.terms.term.Term.sweep"><code class="xref py py-meth docutils literal notranslate"><span class="pre">sweep()</span></code></a> method instead of
<a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.solve" title="fipy.terms.term.Term.solve"><code class="xref py py-meth docutils literal notranslate"><span class="pre">solve()</span></code></a> because we require the residual for output.
We also use the <a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.cacheMatrix" title="fipy.terms.term.Term.cacheMatrix"><code class="xref py py-meth docutils literal notranslate"><span class="pre">cacheMatrix()</span></code></a>,
<a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.matrix" title="fipy.terms.term.Term.matrix"><code class="xref py py-attr docutils literal notranslate"><span class="pre">matrix</span></code></a>,
<a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.cacheRHSvector" title="fipy.terms.term.Term.cacheRHSvector"><code class="xref py py-meth docutils literal notranslate"><span class="pre">cacheRHSvector()</span></code></a> and
<a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.RHSvector" title="fipy.terms.term.Term.RHSvector"><code class="xref py py-attr docutils literal notranslate"><span class="pre">RHSvector</span></code></a> because both the matrix and RHS
vector are required by the SIMPLE algorithm. Additionally, the
<a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.sweep" title="fipy.terms.term.Term.sweep"><code class="xref py py-meth docutils literal notranslate"><span class="pre">sweep()</span></code></a> method is passed an <code class="docutils literal notranslate"><span class="pre">underRelaxation</span></code>
factor to relax the solution. This argument cannot be passed to
<a class="reference internal" href="fipy.terms.term.html#fipy.terms.term.Term.solve" title="fipy.terms.term.Term.solve"><code class="xref py py-meth docutils literal notranslate"><span class="pre">solve()</span></code></a>.</p>
<div class="doctest highlight-default notranslate" id="index-3"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">sweep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sweeps</span><span class="p">):</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="c1">## solve the Stokes equations to get starred values</span>
<span class="gp">... </span>    <span class="n">xVelocityEq</span><span class="o">.</span><span class="n">cacheMatrix</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">xres</span> <span class="o">=</span> <span class="n">xVelocityEq</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">xVelocity</span><span class="p">,</span>
<span class="gp">... </span>                             <span class="n">underRelaxation</span><span class="o">=</span><span class="n">velocityRelaxation</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">xmat</span> <span class="o">=</span> <span class="n">xVelocityEq</span><span class="o">.</span><span class="n">matrix</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">yres</span> <span class="o">=</span> <span class="n">yVelocityEq</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">yVelocity</span><span class="p">,</span>
<span class="gp">... </span>                             <span class="n">underRelaxation</span><span class="o">=</span><span class="n">velocityRelaxation</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="c1">## update the ap coefficient from the matrix diagonal</span>
<span class="gp">... </span>    <span class="n">ap</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">numerix</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xmat</span><span class="o">.</span><span class="n">takeDiagonal</span><span class="p">())</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="c1">## update the face velocities based on starred values with the</span>
<span class="gp">... </span>    <span class="c1">## Rhie-Chow correction.</span>
<span class="gp">... </span>    <span class="c1">## cell pressure gradient</span>
<span class="gp">... </span>    <span class="n">presgrad</span> <span class="o">=</span> <span class="n">pressure</span><span class="o">.</span><span class="n">grad</span>
<span class="gp">... </span>    <span class="c1">## face pressure gradient</span>
<span class="gp">... </span>    <span class="n">facepresgrad</span> <span class="o">=</span> <span class="n">_FaceGradVariable</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xVelocity</span><span class="o">.</span><span class="n">arithmeticFaceValue</span> \
<span class="gp">... </span>         <span class="o">+</span> <span class="n">contrvolume</span> <span class="o">/</span> <span class="n">ap</span><span class="o">.</span><span class="n">arithmeticFaceValue</span> <span class="o">*</span> \
<span class="gp">... </span>           <span class="p">(</span><span class="n">presgrad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">arithmeticFaceValue</span><span class="o">-</span><span class="n">facepresgrad</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">velocity</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">yVelocity</span><span class="o">.</span><span class="n">arithmeticFaceValue</span> \
<span class="gp">... </span>         <span class="o">+</span> <span class="n">contrvolume</span> <span class="o">/</span> <span class="n">ap</span><span class="o">.</span><span class="n">arithmeticFaceValue</span> <span class="o">*</span> \
<span class="gp">... </span>           <span class="p">(</span><span class="n">presgrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">arithmeticFaceValue</span><span class="o">-</span><span class="n">facepresgrad</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">velocity</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">exteriorFaces</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="gp">... </span>    <span class="n">velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">facesTop</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="c1">## solve the pressure correction equation</span>
<span class="gp">... </span>    <span class="n">pressureCorrectionEq</span><span class="o">.</span><span class="n">cacheRHSvector</span><span class="p">()</span>
<span class="gp">... </span>    <span class="c1">## left bottom point must remain at pressure 0, so no correction</span>
<span class="gp">... </span>    <span class="n">pres</span> <span class="o">=</span> <span class="n">pressureCorrectionEq</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">pressureCorrection</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">rhs</span> <span class="o">=</span> <span class="n">pressureCorrectionEq</span><span class="o">.</span><span class="n">RHSvector</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="c1">## update the pressure using the corrected value</span>
<span class="gp">... </span>    <span class="n">pressure</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">pressure</span> <span class="o">+</span> <span class="n">pressureRelaxation</span> <span class="o">*</span> <span class="n">pressureCorrection</span> <span class="p">)</span>
<span class="gp">... </span>    <span class="c1">## update the velocity using the corrected pressure</span>
<span class="gp">... </span>    <span class="n">xVelocity</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">xVelocity</span> <span class="o">-</span> <span class="n">pressureCorrection</span><span class="o">.</span><span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> \
<span class="gp">... </span>                                               <span class="n">ap</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">cellVolumes</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">yVelocity</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">yVelocity</span> <span class="o">-</span> <span class="n">pressureCorrection</span><span class="o">.</span><span class="n">grad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> \
<span class="gp">... </span>                                               <span class="n">ap</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">cellVolumes</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="n">sweep</span><span class="o">%</span><span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="gp">... </span>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sweep:&#39;</span><span class="p">,</span> <span class="n">sweep</span><span class="p">,</span> <span class="s1">&#39;, x residual:&#39;</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> \
<span class="gp">... </span>                                 <span class="s1">&#39;, y residual&#39;</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> \
<span class="gp">... </span>                                 <span class="s1">&#39;, p residual:&#39;</span><span class="p">,</span> <span class="n">pres</span><span class="p">,</span> \
<span class="gp">... </span>                                 <span class="s1">&#39;, continuity:&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rhs</span><span class="p">)))</span>
<span class="gp">...</span>
<span class="gp">... </span>            <span class="n">viewer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/cavity.png"><img alt="flow field for moving lid problem" class="align-center" src="../_images/cavity.png" style="width: 90%;" /></a>
<p>Test values in the last cell.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">numerix</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">pressure</span><span class="o">.</span><span class="n">globalValue</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">162.790867927</span><span class="p">))</span> 
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">numerix</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">xVelocity</span><span class="o">.</span><span class="n">globalValue</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.265072740929</span><span class="p">))</span> 
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">numerix</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">yVelocity</span><span class="o">.</span><span class="n">globalValue</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.150290488304</span><span class="p">))</span> 
<span class="go">1</span>
</pre></div>
</div>
</section>


                <div class='last-updated'>
                Last updated on May 23, 2025.
                Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.1.2.
                </div>
              </div>
  </div>  
  <aside class="nist-page__region nist-page__region--sidebar-second tablet-lg:grid-col-4">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

<strong>FiPy: A Finite Volume PDE Solver Using Python</strong><br />
Version 3.4.5+28.g44ba2a228

<div class="sphinxsidebarsection">
  <h4>Previous topic</h4>
  <p class="topless"><a href="examples.flow.html"
                        title="previous chapter">examples.flow</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="examples.flow.test.html"
                        title="next chapter">examples.flow.test</a></p>
</div>
  <div class="sphinxsidebarsection">
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/generated/examples.flow.stokesCavity.rst.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
  </div>
<div class="sphinxsidebarsection">
<div id="searchbox" style="display: none" role="search">
  <div data-layout-content-preview-placeholder-label="&quot;Sphinx
  Search&quot; field" class="nist-block nist-block--search">
  <h2 id="searchlabel">Quick search</h2>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
  </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
</div>
<div class="sphinxsidebarsection" id="contact-wrapper">
  
        <div data-layout-content-preview-placeholder-label="&quot;Related
        organization tree&quot; views block" class="nist-block nist-block--org">
          
          <h2 class="nist-block__title">Organizations</h2>
              
              <div class="views-element-container"><div
              class="js-view-dom-id-70b0923f677edbe3dda361030ef8dc373cd0ca94065c39cfd81338de767f1019">

            <div class="nist-related-orgs"><div class="term-tree-list"><ul
            class="term"><li class="selected"><a
            href="https://www.nist.gov/nist-organizations/nist-headquarters" hreflang="en">NIST
            Headquarters</a><ul class="term"><li class="selected"><a
            href="https://www.nist.gov/nist-organizations/nist-headquarters/laboratory-programs"
            hreflang="en">Laboratory Programs</a><ul class="term"><li
            class="selected"><a
            href="https://www.nist.gov/nist-organizations/nist-headquarters/laboratory-programs/material-measurement-laboratory"
            hreflang="en">Material Measurement Laboratory</a>
			<ul
			class="term"><li
			class="selected"><a href="https://www.nist.gov/mml/msed"
			hreflang="en">Materials Science and Engineering
			Division</a></li><li
			class="selected"><a href="https://www.nist.gov/mml/ctcms"
			hreflang="en">Center for Theoretical and
			              Computational Materials Science</a></li></ul>
                          </li></ul></li></ul></li></ul></div></div>
          <div class="nist-related-orgs"></div>
          <div class="nist-related-orgs"></div>



        </div>
        </div>

          </div>


          <div data-layout-content-preview-placeholder-label="&quot;NIST
          Staff&quot; field" class="nist-block nist-block--contact">

          <h2 class="nist-block__title">NIST Staff</h2>

                  <div class="nist-field nist-field--label-hidden
                  nist-field--link-list entity-reference nist-field__items
                  nist-field--no-margin">
                            <div class="nist-field__item
                            nist-field--no-margin"><a
                            href="https://www.nist.gov/people/jonathan-e-guyer"
                            hreflang="en">Jonathan E. Guyer</a></div>
                                <div class="nist-field__item
                                nist-field--no-margin"><a
                                href="https://www.nist.gov/people/daniel-wheeler"
                                hreflang="en">Daniel Wheeler</a></div>
                                <div class="nist-field__item
                                nist-field--no-margin"><a
                                href="https://www.nist.gov/people/james-warren"
                                hreflang="en">James A. Warren</a></div>
                  </div>


          </div>

          <div data-layout-content-preview-placeholder-label="&quot;Contact&quot; field"
          class="nist-block nist-block--contact nist-block--mail">

          <h2 class="nist-block__title">
          <a class="" href="../docs/source/CONTACT.html" style="">Contact</a>
          </h2>

          </div>

</div>
        </div>
      </div>
      <div class="clearer"></div>
  </aside>
        </div>
      </div>

      <div class="panel-region--postface">
      <div class="inner region-inner inside">
        
<div class="pane pane--nist-node-date-pane" >

    </div>
      </div>
    </div>

        </section>
        </div>
      </div>

      </div>  
    </div>          

    </div>

  </div>

</div>


  


  <!-- Taken from https://www.filamentgroup.com/lab/html-includes/#another-demo%3A-including-another-html-file -->
  <iframe src="../_static/ntd2d_menu.html" onload="this.before((this.contentDocument.body||this.contentDocument).children[0]);this.remove()"></iframe>
    </div>
  </body>
</html>