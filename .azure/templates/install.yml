parameters:
- name: conda_packages
  type: string
  default: ''
- name: pip_packages
  type: string
  default: ''
- name: solver
  type: string
  default: scipy

steps:
  - bash: |
      mkdir -p ${HOME}/conda
      curl -fsSLo Miniforge3.sh "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-MacOSX-$(uname -m).sh"
      bash Miniforge3.sh -b -p "${HOME}/conda"
      source "${HOME}/conda/etc/profile.d/conda.sh"
      source "${HOME}/conda/etc/profile.d/mamba.sh"
      echo "##vso[task.setvariable variable=CONDA;]${HOME}/conda"
    displayName: Install miniforge
    condition: startsWith(variables.image, 'macos')

  - bash: |
      mkdir -p ${HOME}/conda
      wget -O Miniforge3.sh "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh"
      bash Miniforge3.sh -b -p "${HOME}/conda"
      source "${HOME}/conda/etc/profile.d/conda.sh"
      source "${HOME}/conda/etc/profile.d/mamba.sh"
      echo "##vso[task.setvariable variable=CONDA;]${HOME}/conda"
    displayName: Install miniforge
    condition: startsWith(variables.image, 'ubuntu')

  - bash: echo "##vso[task.prependpath]$CONDA/bin"
    displayName: Add conda to PATH
    condition: or(startsWith(variables.image, 'macos'), startsWith(variables.image, 'ubuntu'))

  - bash: echo "##vso[task.prependpath]$CONDA/Scripts"
    displayName: Add conda to PATH
    condition: startsWith(variables.image, 'windows')

  # On Hosted macOS, the agent user doesn't have ownership of Miniforge's installation directory/
  # We need to take ownership if we want to update conda or install packages globally
  - bash: sudo chown -R $USER $CONDA
    displayName: Take ownership of conda installation
    condition: startsWith(variables.image, 'macos')

  - bash: |
      sudo apt-get --yes install libglu1-mesa
      sudo apt-get --yes install libgl1-mesa-glx
      sudo apt-get --yes install libxrender1
    displayName: Install libGL
    condition: startsWith(variables.image, 'ubuntu')

  - bash: |
      conda config --set always_yes yes --set changeps1 no
      conda config --system --set channel_priority strict
      conda config --system --show channels
      conda config --set solver libmamba

      conda update -n base conda

      conda info
    displayName: Configure Anaconda

  # Most triggered builds use lockfile to ensure failures are
  # due to commit and not due to dependencies
  - bash: |
      conda install --channel=conda-forge --name=base conda-lock
      conda-lock install --name myEnvironment \
        environments/locks/conda-${{ parameters.solver }}-lock.yml
    displayName: Create Anaconda environment from lockfile
    condition: and(ne(variables['Build.CronSchedule.DisplayName'], 'Daily midnight build'),eq(variables['CONDA_ENVIRONMENT_NOT_LOCK'],''))

  # Daily midnight build uses environment.yml files to catch regressions
  # due to updates in dependencies
  - bash: |
      conda env create --name myEnvironment \
        --file environments/${{ parameters.solver }}-environment.yml
    displayName: Create Anaconda environment from environments
    condition: or(eq(variables['Build.CronSchedule.DisplayName'], 'Daily midnight build'), ne(variables['CONDA_ENVIRONMENT_NOT_LOCK'],''))

  - bash: |
      conda env export --name myEnvironment
    displayName: EnvironmentA

  - bash: |
      if [[ "${{ parameters.conda_packages }}" != "" ]]; then
        source activate myEnvironment
        # "Libmamba only supports a subset of the MatchSpec interface for
        # now.  You can only use ('name', 'version', 'build', 'channel',
        # 'subdir'), but you tried to use ('md5',)."
        conda install --solver classic --channel conda-forge ${{ parameters.conda_packages }}
      fi
    displayName: Install Anaconda packages

  - bash: |
      conda env export --name myEnvironment
    displayName: EnvironmentB

  - bash: |
      if [[ "${{ parameters.pip_packages }}" != "" ]]; then
        source activate myEnvironment
        python -m pip install ${{ parameters.pip_packages }}
      fi
    displayName: Install Pip packages

  - bash: |
      conda env export --name myEnvironment
    displayName: Environment
